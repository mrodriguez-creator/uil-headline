<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIL Headline Writing Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .story-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .story-title {
            font-size: 1.3em;
            color: #1e3c72;
            font-weight: bold;
        }

        .story-text {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }

        .headline-input-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .headline-label {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
            display: block;
        }

        .character-grid {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .char-box {
            width: 24px;
            height: 32px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-family: monospace;
            font-size: 14px;
        }

        .char-box.filled {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .char-box.over-limit {
            background: #ffebee;
            border-color: #f44336;
        }

        .headline-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: Georgia, serif;
            margin-bottom: 8px;
        }

        .headline-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #f44336;
            font-weight: bold;
        }

        .submit-section {
            text-align: center;
            margin: 30px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feedback-section {
            display: none;
            margin-top: 30px;
        }

        .feedback-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feedback-headline {
            font-size: 1.2em;
            color: #1e3c72;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .your-headline {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: Georgia, serif;
            font-size: 1.1em;
        }

        .score {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .score.excellent { background: #4caf50; color: white; }
        .score.good { background: #2196f3; color: white; }
        .score.fair { background: #ff9800; color: white; }
        .score.needs-work { background: #f44336; color: white; }

        .feedback-text {
            line-height: 1.6;
            color: #444;
            margin: 10px 0;
        }

        .feedback-list {
            margin: 15px 0;
            padding-left: 20px;
        }

        .feedback-list li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .improvement {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .strength {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .try-again-btn {
            margin-top: 30px;
            text-align: center;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box strong {
            color: #1976d2;
        }

        /* --- Feature 1: Rule Violation Highlighting --- */
        .violations-container {
            margin-top: 6px;
            min-height: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .violation-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }

        .violation-tag.article { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .violation-tag.past-tense { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .violation-tag.passive-voice { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .violation-tag.l-word { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .violation-tag.punctuation { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .violation-tag.name-issue { background: #e2d5f1; color: #4a235a; border: 1px solid #d2b4de; }

        /* --- Feature 2: Timed Practice Mode --- */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0 10px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: Georgia, serif;
            transition: all 0.2s;
        }

        .mode-btn:hover { background: #f0f0ff; }
        .mode-btn.active { background: #667eea; color: white; }
        .mode-btn.mock-active { background: #e74c3c; color: white; border-color: #e74c3c; }

        .timer-bar {
            display: none;
            background: #1e3c72;
            color: white;
            text-align: center;
            padding: 12px 20px;
            font-size: 1.6em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-radius: 12px 12px 0 0;
        }

        .timer-bar.visible { display: block; }
        .timer-bar.warning-10 { background: #e67e22; }
        .timer-bar.warning-5 { background: #e74c3c; animation: pulse 1s ease-in-out infinite; }
        .timer-bar.warning-1 { background: #c0392b; animation: pulse 0.5s ease-in-out infinite; }
        .timer-bar.expired { background: #7f8c8d; animation: none; }
        .timer-bar.mock { background: #c0392b; }
        .timer-bar.mock.warning-10 { background: #e67e22; }
        .timer-bar.mock.warning-5 { background: #e74c3c; animation: pulse 1s ease-in-out infinite; }
        .timer-bar.mock.warning-1 { background: #c0392b; animation: pulse 0.5s ease-in-out infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .time-up-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .time-up-overlay.visible { display: flex; }

        .time-up-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .time-up-card h2 { font-size: 2em; color: #e74c3c; margin-bottom: 15px; }
        .time-up-card p { color: #666; font-size: 1.1em; margin-bottom: 10px; }

        /* --- Feature 6: Side-by-Side Comparison --- */
        .comparison-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 12px 0;
        }

        .comparison-col {
            padding: 12px;
            border-radius: 6px;
            font-family: Georgia, serif;
            font-size: 1.05em;
        }

        .comparison-col.yours {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
        }

        .comparison-col.suggested {
            background: #e8f5e9;
            border: 2px solid #66bb6a;
        }

        .comparison-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .comparison-col.yours .comparison-label { color: #999; }
        .comparison-col.suggested .comparison-label { color: #2e7d32; }

        /* --- Feature 5: Weakness Dashboard --- */
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #9c27b0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-title {
            font-size: 1.2em;
            color: #9c27b0;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .weakness-bar-container {
            margin: 10px 0;
        }

        .weakness-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 4px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .weakness-bar-label .cat-name { color: #444; font-weight: 600; }
        .weakness-bar-label .cat-count { color: #999; }

        .weakness-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .weakness-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .dashboard-actions {
            margin-top: 15px;
            text-align: right;
        }

        .clear-data-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            color: #999;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .clear-data-btn:hover { border-color: #e74c3c; color: #e74c3c; }

        /* --- Feature 9: Progress Chart --- */
        .progress-chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .progress-chart-title {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 200px;
            margin: 15px 0;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .streak-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 6px;
            margin-top: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
            font-weight: 600;
        }

        .streak-banner.hot { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }
        .streak-banner.improving { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .streak-banner.steady { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }

        /* --- Feature 10: Story Archive --- */
        .archive-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #e67e22;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .archive-title {
            font-size: 1.2em;
            color: #e67e22;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .archive-count {
            font-size: 0.75em;
            color: #999;
            font-weight: normal;
        }

        .archive-list {
            list-style: none;
            padding: 0;
        }

        .archive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 10px;
        }

        .archive-item:hover {
            border-color: #e67e22;
            background: #fff8f0;
        }

        .archive-item-info {
            flex: 1;
            min-width: 0;
        }

        .archive-item-date {
            font-size: 12px;
            color: #999;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .archive-item-preview {
            font-size: 0.9em;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        .archive-item-score {
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
            white-space: nowrap;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .archive-item-mode {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .archive-item-mode.practice { background: #e3f2fd; color: #1565c0; }
        .archive-item-mode.timed { background: #fff3cd; color: #856404; }
        .archive-item-mode.mock { background: #f8d7da; color: #721c24; }

        .archive-empty {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 0.95em;
        }

        .archive-load-btn {
            background: none;
            border: 1px solid #e67e22;
            color: #e67e22;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            transition: all 0.2s;
        }

        .archive-load-btn:hover { background: #e67e22; color: white; }

        /* Mock contest badge */
        .mock-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.5px;
            margin-left: 10px;
            vertical-align: middle;
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.6em; }
            .content { padding: 20px; }
            .char-box { width: 20px; height: 28px; font-size: 12px; }
            .mode-selector { flex-direction: column; align-items: stretch; }
            .mode-btn { text-align: center; }
            .timer-bar { font-size: 1.3em; padding: 10px; }
            .comparison-row { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: 1fr; }
        }

        /* --- Feature 11: Print-Friendly Results --- */
        @media print {
            body { background: white !important; padding: 0 !important; }
            .container { box-shadow: none !important; border-radius: 0 !important; }
            .header { background: white !important; color: black !important; padding: 15px !important; border-bottom: 2px solid #333; }
            .header h1 { font-size: 1.5em; }
            .timer-bar, .mode-selector, #mode-descriptions, #start-section, .submit-section,
            .try-again-btn, .dark-toggle, .story-count-selector, #archive-section,
            .dashboard-actions, .clear-data-btn, .print-btn-container { display: none !important; }
            .feedback-section { display: block !important; }
            .feedback-card { break-inside: avoid; box-shadow: none !important; border: 1px solid #ccc; margin-bottom: 15px; }
            .score { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .comparison-col.suggested { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .strength, .improvement { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .progress-chart-card, .dashboard-card { break-inside: avoid; box-shadow: none !important; border: 1px solid #ccc; }
        }

        .print-btn-container { text-align: right; margin-bottom: 10px; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
        .print-btn, .action-btn {
            background: none; border: 1px solid #667eea; color: #667eea;
            padding: 6px 14px; border-radius: 4px; cursor: pointer;
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-weight: 600;
            transition: all 0.2s;
        }
        .print-btn:hover, .action-btn:hover { background: #667eea; color: white; }
        .action-btn.share-btn { border-color: #4caf50; color: #4caf50; }
        .action-btn.share-btn:hover { background: #4caf50; color: white; }
        .action-btn.csv-btn { border-color: #ff9800; color: #ff9800; }
        .action-btn.csv-btn:hover { background: #ff9800; color: white; }
        .action-btn.copy-btn { border-color: #2196f3; color: #2196f3; }
        .action-btn.copy-btn:hover { background: #2196f3; color: white; }
        .copied-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 24px; border-radius: 8px;
            font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            z-index: 999; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .copied-toast.visible { opacity: 1; }

        /* Share Code Modal */
        .share-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 500; display: none;
            justify-content: center; align-items: center;
        }
        .share-modal-overlay.visible { display: flex; }
        .share-modal {
            background: white; border-radius: 12px; padding: 30px; max-width: 520px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;
        }
        .share-modal h3 {
            color: #1e3c72; margin-bottom: 10px; font-size: 1.3em;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .share-modal p {
            color: #666; font-size: 0.95em; margin-bottom: 15px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.5;
        }
        .share-modal .student-name-input {
            width: 100%; padding: 10px 14px; border: 2px solid #ddd; border-radius: 6px;
            font-size: 15px; margin-bottom: 12px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            transition: border-color 0.2s;
        }
        .share-modal .student-name-input:focus { border-color: #667eea; outline: none; }
        .share-code-box {
            background: #f5f5f5; border: 2px dashed #ccc; border-radius: 8px;
            padding: 15px; font-family: monospace; font-size: 11px;
            word-break: break-all; max-height: 120px; overflow-y: auto;
            color: #333; margin-bottom: 12px; line-height: 1.4;
        }
        .share-modal .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .share-modal .modal-btn {
            padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .share-modal .modal-btn.primary { background: #4caf50; color: white; }
        .share-modal .modal-btn.primary:hover { background: #43a047; }
        .share-modal .modal-btn.secondary { background: #eee; color: #333; }
        .share-modal .modal-btn.secondary:hover { background: #ddd; }
        .share-modal .close-btn {
            position: absolute; top: 10px; right: 15px; background: none; border: none;
            font-size: 22px; cursor: pointer; color: #999; padding: 5px;
        }
        .share-modal .close-btn:hover { color: #333; }
        body.dark-mode .share-modal { background: #2d2d2d; }
        body.dark-mode .share-modal h3 { color: #8ab4f8; }
        body.dark-mode .share-modal p { color: #bbb; }
        body.dark-mode .share-modal .student-name-input { background: #3a3a3a; border-color: #555; color: #eee; }
        body.dark-mode .share-code-box { background: #3a3a3a; border-color: #555; color: #ddd; }

        /* --- Feature 12: Dark Mode --- */
        .dark-toggle {
            position: fixed; top: 12px; right: 12px; z-index: 300;
            background: rgba(255,255,255,0.9); border: 1px solid #ccc; border-radius: 20px;
            padding: 6px 14px; cursor: pointer; font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-weight: 600;
            transition: all 0.2s; color: #333;
        }
        .dark-toggle:hover { background: #667eea; color: white; border-color: #667eea; }

        body.dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark-mode .container { background: #1e1e2e; color: #e0e0e0; }
        body.dark-mode .header { background: linear-gradient(135deg, #0f1b3d 0%, #1a2d5a 100%); }
        body.dark-mode .content { color: #e0e0e0; }
        body.dark-mode .info-box { background: #1a2744; border-color: #2196f3; color: #b0c4de; }
        body.dark-mode .info-box a { color: #64b5f6; }
        body.dark-mode .story-section { background: #252540; border-left-color: #667eea; }
        body.dark-mode .story-text { color: #ccc; }
        body.dark-mode .headline-input-section { background: #2a2a3e; border-color: #444; }
        body.dark-mode .headline-input { background: #1e1e2e; color: #e0e0e0; border-color: #444; }
        body.dark-mode .headline-input:focus { border-color: #667eea; }
        body.dark-mode .char-box { background: #2a2a3e; border-color: #444; color: #aaa; }
        body.dark-mode .char-box.filled { background: #1a3a5c; border-color: #667eea; color: #e0e0e0; }
        body.dark-mode .char-box.over-limit { background: #4a1a1a; border-color: #f44336; color: #ff8a80; }
        body.dark-mode .char-count { color: #999; }
        body.dark-mode .feedback-card { background: #252540; border-left-color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body.dark-mode .your-headline { background: #2a2a3e; color: #e0e0e0; }
        body.dark-mode .feedback-text { color: #bbb; }
        body.dark-mode .comparison-col.yours { background: #2a2a3e; border-color: #444; color: #e0e0e0; }
        body.dark-mode .comparison-col.suggested { background: #1a3328; border-color: #4caf50; color: #e0e0e0; }
        body.dark-mode .strength { background: #1a3328; border-left-color: #28a745; color: #b0d8b0; }
        body.dark-mode .improvement { background: #3a2e1a; border-left-color: #ffc107; color: #d4c08a; }
        body.dark-mode .mode-btn { background: #2a2a3e; color: #b0b0d0; border-color: #444; }
        body.dark-mode .mode-btn:hover { background: #3a3a5e; }
        body.dark-mode .mode-btn.active { background: #667eea; color: white; }
        body.dark-mode .mode-btn.mock-active { background: #e74c3c; color: white; border-color: #e74c3c; }
        body.dark-mode .dashboard-card { background: #252540; border-left-color: #9c27b0; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body.dark-mode .progress-chart-card { background: #252540; border-left-color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body.dark-mode .archive-card { background: #252540; border-left-color: #e67e22; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body.dark-mode .archive-item { border-color: #444; color: #e0e0e0; }
        body.dark-mode .archive-item:hover { border-color: #e67e22; background: #2a2a3e; }
        body.dark-mode .stat-box { background: #2a2a3e; }
        body.dark-mode .stat-label { color: #999; }
        body.dark-mode .headline-label { color: #8899cc; }
        body.dark-mode .story-title { color: #8899cc; }
        body.dark-mode .dark-toggle { background: rgba(30,30,46,0.9); color: #e0e0e0; border-color: #555; }
        body.dark-mode .dark-toggle:hover { background: #667eea; color: white; }

        /* --- Feature 14: Score Breakdown by Headline Type --- */
        .breakdown-card {
            background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;
            border-left: 4px solid #2196f3; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body.dark-mode .breakdown-card { background: #252540; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .breakdown-title { font-size: 1.2em; color: #2196f3; margin-bottom: 15px; font-weight: bold; }
        .breakdown-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }
        .breakdown-item {
            text-align: center; padding: 12px; background: #f8f9fa; border-radius: 6px;
        }
        body.dark-mode .breakdown-item { background: #2a2a3e; }
        .breakdown-type-label {
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #999;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-weight: 600; margin-bottom: 6px;
        }
        .breakdown-score {
            font-size: 1.8em; font-weight: bold; color: #667eea;
        }
        .breakdown-max { font-size: 12px; color: #999; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }

        @media (max-width: 600px) {
            .breakdown-grid { grid-template-columns: 1fr 1fr; }
        }

        /* --- Feature 15: Quick Practice (Story Count Selector) --- */
        .story-count-selector {
            display: flex; justify-content: center; gap: 8px; margin: 10px 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .story-count-btn {
            padding: 6px 14px; border: 2px solid #e0e0e0; border-radius: 6px;
            background: white; color: #666; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .story-count-btn:hover { border-color: #667eea; color: #667eea; }
        .story-count-btn.active { background: #667eea; color: white; border-color: #667eea; }
        body.dark-mode .story-count-btn { background: #2a2a3e; color: #b0b0d0; border-color: #444; }
        body.dark-mode .story-count-btn:hover { border-color: #667eea; color: #667eea; }
        body.dark-mode .story-count-btn.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <!-- Feature 12: Dark Mode Toggle -->
    <button class="dark-toggle" id="dark-toggle" onclick="toggleDarkMode()">Dark Mode</button>

    <div class="container">
        <div class="timer-bar" id="timer-bar">30:00</div>

        <div class="header">
            <h1>UIL Headline Writing Trainer</h1>
            <p>Practice writing headlines with AI-powered feedback</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>How it works:</strong> Just like a real UIL contest, you'll receive 6 different news stories. Write a headline for each one following UIL rules, then get detailed AI feedback to improve your skills!
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2196f3;">
                    <strong>New to UIL Headline Writing?</strong> <a href="tutorial.html" style="color: #1976d2; text-decoration: underline;">Start with our beginner tutorial</a>
                    <span style="margin: 0 8px; color: #999;">|</span>
                    <strong>Target Your Weaknesses:</strong> <a href="drills.html" style="color: #1976d2; text-decoration: underline;">Try skill drills</a>
                    <span style="margin: 0 8px; color: #999;">|</span>
                    <a href="mistakes.html" style="color: #1976d2; text-decoration: underline;">Common mistakes</a>
                    <span style="margin: 0 8px; color: #999;">|</span>
                    <a href="verbs.html" style="color: #1976d2; text-decoration: underline;">Verb bank</a>
                </div>
            </div>

            <div class="mode-selector" id="mode-selector">
                <button class="mode-btn active" onclick="setMode('practice')" id="mode-practice">Practice Mode</button>
                <button class="mode-btn" onclick="setMode('timed')" id="mode-timed">Timed Mode (30 min)</button>
                <button class="mode-btn" onclick="setMode('mock')" id="mode-mock">Mock Contest</button>
            </div>
            <div id="mode-descriptions" style="font-size: 13px; color: #666; text-align: center; margin: 0 0 15px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.5;">
                <span id="mode-desc-text"><strong style="color: #667eea;">Practice Mode:</strong> No timer. Real-time rule violation hints appear as you type. Get full AI feedback after submitting.</span>
            </div>

            <!-- Feature 15: Quick Practice - Story Count Selector -->
            <div class="story-count-selector" id="story-count-selector">
                <span style="font-size: 13px; color: #666; align-self: center; margin-right: 4px;">Stories:</span>
                <button class="story-count-btn" onclick="setStoryCount(1)">1</button>
                <button class="story-count-btn" onclick="setStoryCount(2)">2</button>
                <button class="story-count-btn" onclick="setStoryCount(3)">3</button>
                <button class="story-count-btn active" onclick="setStoryCount(6)">6 (UIL)</button>
            </div>

            <div id="start-section">
                <div style="text-align: center; padding: 40px 0;">
                    <button class="btn" onclick="generateStory()" id="generate-btn">Generate 6 Stories (UIL Format)</button>
                </div>
            </div>

            <div id="story-section" style="display: none;">
                <div id="story-headline-pairs"></div>

                <div class="submit-section">
                    <button class="btn" onclick="submitHeadlines()" id="submit-btn">Submit All Headlines for Feedback</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your 6 headlines...</p>
            </div>

            <div class="feedback-section" id="feedback-section">
                <div class="print-btn-container">
                    <button class="action-btn copy-btn" onclick="copyResultsToClipboard()">Copy Results</button>
                    <button class="action-btn csv-btn" onclick="exportCSV()">Export CSV</button>
                    <button class="action-btn share-btn" onclick="openShareModal()">Share with Coach</button>
                    <button class="print-btn" onclick="window.print()">Print Results</button>
                </div>
                <div id="feedback-content"></div>
                <div id="breakdown-container"></div>
                <div id="progress-chart-container"></div>
                <div id="dashboard-container"></div>
                <div class="try-again-btn">
                    <button class="btn" onclick="resetApp()">Try Another Set of 6 Stories</button>
                </div>
            </div>

            <!-- Feature 10: Story Archive (shown on start screen) -->
            <div id="archive-section"></div>
        </div>
    </div>

    <!-- Share with Coach Modal -->
    <div class="share-modal-overlay" id="share-modal-overlay" onclick="closeShareModal(event)">
        <div class="share-modal">
            <button class="close-btn" onclick="document.getElementById('share-modal-overlay').classList.remove('visible')">&times;</button>
            <h3>Share Results with Coach</h3>
            <p>Enter your name, then copy the code below and send it to your coach. They can paste it into the <a href="coach.html" target="_blank" style="color: #667eea;">Coach Dashboard</a> to view your full results.</p>
            <input type="text" class="student-name-input" id="student-name-input" placeholder="Your name (e.g., Jane Smith)" maxlength="50">
            <div class="share-code-box" id="share-code-box">Generate code first...</div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="document.getElementById('share-modal-overlay').classList.remove('visible')">Close</button>
                <button class="modal-btn primary" id="generate-share-btn" onclick="generateShareCode()">Generate Code</button>
                <button class="modal-btn primary" id="copy-share-btn" onclick="copyShareCode()" style="display:none;">Copy Code</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="copied-toast" id="copied-toast"></div>

    <!-- Time's Up Overlay -->
    <div class="time-up-overlay" id="time-up-overlay">
        <div class="time-up-card">
            <h2>Time's Up!</h2>
            <p>Your 30 minutes have expired.</p>
            <p style="font-size: 0.95em; color: #999;" id="time-up-subtext">You can submit what you have or keep editing without the timer.</p>
            <button class="btn" onclick="submitAfterTimeout()" style="margin-top: 20px;">Submit My Headlines</button>
            <br>
            <button class="btn" onclick="dismissTimeout()" style="margin-top: 10px; background: #6c757d;" id="keep-editing-btn">Keep Editing (Untimed)</button>
        </div>
    </div>

    <script>
        let currentStories = []; // Array of 6 stories
        let headlines = [];

        // Mode state: 'practice', 'timed', or 'mock'
        let currentMode = 'practice';
        let timerInterval = null;
        let timeRemaining = 1800;
        let timerRunning = false;

        // Real UIL format: 6 stories with different headline assignments
        // Based on actual UIL Invitational, District, Regional and State tests
        const headlineRequirements = [
            { type: 'single', lines: 1, minCount: 24, maxCount: 30, label: '1-line headline counting 24-30' },
            { type: 'single', lines: 2, minCount: 22, maxCount: 28, label: '2-line headline with each line counting 22-28' },
            { type: 'single', lines: 3, minCount: 16, maxCount: 22, label: '3-line headline with each line counting 16-22' },
            { type: 'main+secondary', mainLines: 1, mainMin: 8, mainMax: 14, secLines: 2, secMin: 20, secMax: 26, label: '1-line main headline counting 8-14 and 2-line secondary headline with each line counting 20-26' },
            { type: 'main+secondary', mainLines: 1, mainMin: 6, mainMax: 12, secLines: 1, secMin: 22, secMax: 28, label: '1-line main headline counting 6-12 and a 1-line secondary headline counting 22-28' },
            { type: 'single', lines: 1, minCount: 24, maxCount: 30, label: '1-line headline counting 24-30' }
        ];

        // =============================================
        // Feature 1: Rule Violation Detection
        // =============================================

        const IRREGULAR_PAST = new Set([
            'won', 'said', 'told', 'went', 'came', 'made', 'took',
            'gave', 'found', 'knew', 'thought', 'got', 'saw', 'ran',
            'began', 'left', 'brought', 'held', 'wrote', 'stood',
            'lost', 'paid', 'met', 'spent', 'built', 'sent',
            'fell', 'felt', 'kept', 'became', 'grew', 'drew', 'broke',
            'spoke', 'chose', 'rose', 'drove', 'rode', 'wore', 'flew',
            'sang', 'swam', 'threw', 'caught', 'taught', 'fought',
            'bought', 'led', 'was', 'were', 'had', 'did'
        ]);

        const NOT_PAST_TENSE = new Set([
            'bed', 'red', 'fed', 'shed', 'sled', 'wed',
            'hundred', 'sacred', 'wicked', 'naked', 'speed',
            'need', 'seed', 'feed', 'freed', 'breed', 'agreed',
            'guaranteed', 'proceed', 'succeed', 'indeed'
        ]);

        const COMMON_NON_NAME_PHRASES = new Set([
            'new york', 'high school', 'student council', 'national honor',
            'honor society', 'spring break', 'fall semester', 'summer camp',
            'state championship', 'school board', 'school district',
            'middle school', 'junior varsity', 'varsity football',
            'north texas', 'south texas', 'east texas', 'west texas',
            'red cross', 'boy scouts', 'girl scouts', 'united states',
            'first place', 'second place', 'third place'
        ]);

        function checkViolations(text) {
            const violations = [];
            if (!text.trim()) return violations;

            var articleRegex = /\b(a|an|the)\b/gi;
            var match;
            while ((match = articleRegex.exec(text)) !== null) {
                violations.push({ type: 'article', label: 'Article: "' + match[0] + '"' });
            }

            var edRegex = /\b(\w{3,}ed)\b/gi;
            while ((match = edRegex.exec(text)) !== null) {
                var word = match[1].toLowerCase();
                // Skip all-caps words — they are abbreviations (LED, FRED, etc.)
                if (match[1] === match[1].toUpperCase()) continue;
                if (!NOT_PAST_TENSE.has(word)) {
                    violations.push({ type: 'past-tense', label: 'Past tense? "' + match[1] + '"' });
                }
            }

            var irregularRegex = new RegExp('\\b(' + Array.from(IRREGULAR_PAST).join('|') + ')\\b', 'gi');
            while ((match = irregularRegex.exec(text)) !== null) {
                // Skip all-caps words — they are abbreviations (LED, WON, etc.)
                if (match[1] === match[1].toUpperCase()) continue;
                violations.push({ type: 'past-tense', label: 'Past tense: "' + match[1] + '"' });
            }

            var passiveRegex = /\b(is|are|was|were|been|being|be)\s+(\w+ed|\w+en)\b/gi;
            while ((match = passiveRegex.exec(text)) !== null) {
                // Skip if the second word is all-caps (abbreviation)
                if (match[2] === match[2].toUpperCase()) continue;
                violations.push({ type: 'passive-voice', label: 'Passive: "' + match[0] + '"' });
            }

            var lWordRegex = /\b(leaguetown|lhs|our\s+school)\b/gi;
            while ((match = lWordRegex.exec(text)) !== null) {
                violations.push({ type: 'l-word', label: 'L-word: "' + match[0] + '"' });
            }

            var punctRegex = /[?!&]/g;
            while ((match = punctRegex.exec(text)) !== null) {
                var labels = { '?': 'Question mark', '!': 'Exclamation mark', '&': 'Ampersand' };
                violations.push({ type: 'punctuation', label: labels[match[0]] });
            }

            var nameRegex = /\b([A-Z][a-z]+)\s+([A-Z][a-z]+)\b/g;
            while ((match = nameRegex.exec(text)) !== null) {
                var phrase = match[1] + ' ' + match[2];
                if (!COMMON_NON_NAME_PHRASES.has(phrase.toLowerCase())) {
                    violations.push({ type: 'name-issue', label: 'Full name? "' + phrase + '"' });
                }
            }

            return violations;
        }

        function renderViolations(violations, containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            var seen = new Set();
            violations.forEach(function(v) {
                if (seen.has(v.label)) return;
                seen.add(v.label);
                var tag = document.createElement('span');
                tag.className = 'violation-tag ' + v.type;
                tag.textContent = v.label;
                container.appendChild(tag);
            });
        }

        // =============================================
        // Feature 2 & 4: Mode Selection & Timer
        // =============================================

        var modeDescriptions = {
            practice: '<strong style="color: #667eea;">Practice Mode:</strong> No timer. Real-time rule violation hints appear as you type. Get full AI feedback after submitting.',
            timed: '<strong style="color: #e67e22;">Timed Mode:</strong> 30-minute countdown. Rule violation hints still active. Warnings at 10, 5, and 1 minute. Option to keep editing if time runs out.',
            mock: '<strong style="color: #e74c3c;">Mock Contest:</strong> Simulates a real UIL contest. 30-minute countdown with no rule hints. When time expires, you must submit. No safety net.'
        };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('mode-practice').className = 'mode-btn' + (mode === 'practice' ? ' active' : '');
            document.getElementById('mode-timed').className = 'mode-btn' + (mode === 'timed' ? ' active' : '');
            document.getElementById('mode-mock').className = 'mode-btn' + (mode === 'mock' ? ' mock-active' : '');

            document.getElementById('mode-desc-text').innerHTML = modeDescriptions[mode];

            if (mode === 'practice' && timerRunning) {
                stopTimer();
                document.getElementById('timer-bar').className = 'timer-bar';
            }
        }

        function startTimer() {
            timeRemaining = 1800;
            timerRunning = true;
            var timerBar = document.getElementById('timer-bar');
            var isMock = (currentMode === 'mock');
            timerBar.className = 'timer-bar visible' + (isMock ? ' mock' : '');
            updateTimerDisplay();

            timerInterval = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();

                var timerBar = document.getElementById('timer-bar');
                var base = 'timer-bar visible' + (currentMode === 'mock' ? ' mock' : '');
                if (timeRemaining <= 60) {
                    timerBar.className = base + ' warning-1';
                } else if (timeRemaining <= 300) {
                    timerBar.className = base + ' warning-5';
                } else if (timeRemaining <= 600) {
                    timerBar.className = base + ' warning-10';
                }

                if (timeRemaining <= 0) {
                    stopTimer();
                    handleTimeExpired();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            var minutes = Math.floor(timeRemaining / 60);
            var seconds = timeRemaining % 60;
            var label = currentMode === 'mock' ? 'MOCK CONTEST  ' : '';
            document.getElementById('timer-bar').textContent = label + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            timerRunning = false;
        }

        function handleTimeExpired() {
            var timerBar = document.getElementById('timer-bar');
            timerBar.className = 'timer-bar visible expired';
            timerBar.textContent = "TIME'S UP";

            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = true;
                input.style.opacity = '0.7';
                input.style.backgroundColor = '#f5f5f5';
            });

            // In mock mode, no option to keep editing
            if (currentMode === 'mock') {
                document.getElementById('keep-editing-btn').style.display = 'none';
                document.getElementById('time-up-subtext').textContent = 'Contest over! Your headlines will be submitted for scoring.';
            } else {
                document.getElementById('keep-editing-btn').style.display = '';
                document.getElementById('time-up-subtext').textContent = 'You can submit what you have or keep editing without the timer.';
            }

            document.getElementById('time-up-overlay').classList.add('visible');
        }

        function submitAfterTimeout() {
            document.getElementById('time-up-overlay').classList.remove('visible');
            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = false;
                input.style.opacity = '';
                input.style.backgroundColor = '';
            });
            submitHeadlines(true);
        }

        function dismissTimeout() {
            document.getElementById('time-up-overlay').classList.remove('visible');
            document.getElementById('timer-bar').className = 'timer-bar';
            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = false;
                input.style.opacity = '';
                input.style.backgroundColor = '';
            });
            setMode('practice');
        }

        // =============================================
        // Feature 5: Weakness Dashboard (localStorage)
        // =============================================

        function loadHistory() {
            try {
                var data = localStorage.getItem('uil-headline-history');
                return data ? JSON.parse(data) : { sessions: [], weaknesses: {} };
            } catch (e) { return { sessions: [], weaknesses: {} }; }
        }

        function saveHistory(history) {
            try { localStorage.setItem('uil-headline-history', JSON.stringify(history)); } catch (e) {}
        }

        function recordSession(evaluation) {
            var history = loadHistory();

            // Save session score
            history.sessions.push({
                date: new Date().toISOString(),
                score: evaluation.overallScore,
                mode: currentMode
            });

            // Tally improvement categories from each headline
            evaluation.headlines.forEach(function(hl) {
                if (hl.improvements && hl.improvements.length > 0) {
                    hl.improvements.forEach(function(imp) {
                        var cat = categorizeImprovement(imp);
                        if (!history.weaknesses[cat]) history.weaknesses[cat] = 0;
                        history.weaknesses[cat]++;
                    });
                }
            });

            saveHistory(history);
        }

        function categorizeImprovement(text) {
            var t = text.toLowerCase();
            if (t.includes('character count') || t.includes('over count') || t.includes('under count') || t.includes('char')) return 'Character Count';
            if (t.includes('passive') || t.includes('voice')) return 'Passive Voice';
            if (t.includes('past tense') || t.includes('tense') || t.includes('-ed')) return 'Past Tense';
            if (t.includes('article') || t.includes(' a ') || t.includes(' an ') || t.includes(' the ')) return 'Articles';
            if (t.includes('first name') || t.includes('full name') || t.includes('last name') || t.includes('name')) return 'Name Usage';
            if (t.includes('main idea') || t.includes('lead') || t.includes('misses')) return 'Missed Main Idea';
            if (t.includes('word split') || t.includes('split')) return 'Word Splits';
            if (t.includes('verb') || t.includes('strong')) return 'Weak Verbs';
            if (t.includes('specific') || t.includes('generic')) return 'Specificity';
            if (t.includes('l-word') || t.includes('leaguetown') || t.includes('lhs')) return 'L-Words';
            return 'Other';
        }

        function renderDashboard() {
            var history = loadHistory();
            var container = document.getElementById('dashboard-container');

            if (history.sessions.length === 0) {
                container.innerHTML = '';
                return;
            }

            var totalSessions = history.sessions.length;
            var avgScore = (history.sessions.reduce(function(sum, s) { return sum + s.score; }, 0) / totalSessions).toFixed(1);
            var bestScore = Math.max.apply(null, history.sessions.map(function(s) { return s.score; }));

            // Sort weaknesses by count descending
            var weakEntries = Object.keys(history.weaknesses).map(function(key) {
                return { cat: key, count: history.weaknesses[key] };
            }).sort(function(a, b) { return b.count - a.count; });

            var maxCount = weakEntries.length > 0 ? weakEntries[0].count : 1;

            var colors = {
                'Character Count': '#f44336', 'Passive Voice': '#e91e63', 'Past Tense': '#9c27b0',
                'Articles': '#673ab7', 'Name Usage': '#3f51b5', 'Missed Main Idea': '#2196f3',
                'Word Splits': '#00bcd4', 'Weak Verbs': '#009688', 'Specificity': '#4caf50',
                'L-Words': '#ff9800', 'Other': '#795548'
            };

            var barsHtml = '';
            weakEntries.slice(0, 6).forEach(function(entry) {
                var pct = Math.round((entry.count / maxCount) * 100);
                var color = colors[entry.cat] || '#667eea';
                barsHtml +=
                    '<div class="weakness-bar-container">' +
                        '<div class="weakness-bar-label">' +
                            '<span class="cat-name">' + entry.cat + '</span>' +
                            '<span class="cat-count">' + entry.count + ' time' + (entry.count !== 1 ? 's' : '') + '</span>' +
                        '</div>' +
                        '<div class="weakness-bar">' +
                            '<div class="weakness-bar-fill" style="width: ' + pct + '%; background: ' + color + ';"></div>' +
                        '</div>' +
                    '</div>';
            });

            container.innerHTML =
                '<div class="dashboard-card">' +
                    '<div class="dashboard-title">Your Weakness Breakdown</div>' +
                    '<p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">Based on ' + totalSessions + ' practice session' + (totalSessions !== 1 ? 's' : '') + ' — focus your practice on the top categories.</p>' +
                    '<div class="dashboard-stats">' +
                        '<div class="stat-box"><div class="stat-number">' + totalSessions + '</div><div class="stat-label">Sessions</div></div>' +
                        '<div class="stat-box"><div class="stat-number">' + avgScore + '</div><div class="stat-label">Avg Score</div></div>' +
                        '<div class="stat-box"><div class="stat-number">' + bestScore + '</div><div class="stat-label">Best Score</div></div>' +
                    '</div>' +
                    (barsHtml ? '<div style="margin-top: 20px;">' + barsHtml + '</div>' : '<p style="color: #999; margin-top: 15px;">No specific weaknesses identified yet.</p>') +
                    '<div class="dashboard-actions">' +
                        '<button class="clear-data-btn" onclick="clearHistory()">Clear Practice History</button>' +
                    '</div>' +
                '</div>';
        }

        function clearHistory() {
            if (confirm('Clear all practice history? This cannot be undone.')) {
                localStorage.removeItem('uil-headline-history');
                renderDashboard();
            }
        }

        // =============================================
        // Feature 9: Progress Chart (Score Over Time)
        // =============================================

        function renderProgressChart() {
            var history = loadHistory();
            var container = document.getElementById('progress-chart-container');
            if (!container) return;

            if (history.sessions.length < 2) {
                container.innerHTML = '';
                return;
            }

            var sessions = history.sessions.slice(-20); // last 20 sessions
            var maxScore = 24;

            // Calculate trend
            var recentAvg = 0;
            var olderAvg = 0;
            var mid = Math.floor(sessions.length / 2);
            for (var i = 0; i < sessions.length; i++) {
                if (i < mid) olderAvg += sessions[i].score;
                else recentAvg += sessions[i].score;
            }
            olderAvg = olderAvg / mid;
            recentAvg = recentAvg / (sessions.length - mid);

            var streakHtml = '';
            var diff = recentAvg - olderAvg;
            if (diff > 2) {
                streakHtml = '<div class="streak-banner improving">Trending up! Your recent average is ' + recentAvg.toFixed(1) + ' vs earlier ' + olderAvg.toFixed(1) + '. Keep it going!</div>';
            } else if (diff < -2) {
                streakHtml = '<div class="streak-banner hot">Your recent scores dipped. Focus on your top weaknesses above and try some drills.</div>';
            } else {
                streakHtml = '<div class="streak-banner steady">Holding steady around ' + recentAvg.toFixed(1) + '/24. Push for 20+ with targeted drills!</div>';
            }

            // Build SVG chart with proper coordinate space
            var chartW = 600;
            var chartH = 200;
            var padLeft = 40;
            var padRight = 15;
            var padTop = 15;
            var padBottom = 15;
            var plotW = chartW - padLeft - padRight;
            var plotH = chartH - padTop - padBottom;

            var points = sessions.map(function(s, i) {
                var x = padLeft + (sessions.length === 1 ? plotW / 2 : (i / (sessions.length - 1)) * plotW);
                var y = padTop + plotH - (s.score / maxScore) * plotH;
                return { x: x, y: y, score: s.score, date: s.date, mode: s.mode || 'practice' };
            });

            // SVG path
            var pathD = points.map(function(p, i) {
                return (i === 0 ? 'M' : 'L') + p.x.toFixed(1) + ',' + p.y.toFixed(1);
            }).join(' ');

            // Fill area
            var areaD = pathD + ' L' + points[points.length - 1].x.toFixed(1) + ',' + (padTop + plotH) + ' L' + points[0].x.toFixed(1) + ',' + (padTop + plotH) + ' Z';

            // Y-axis labels
            var yLabels = [0, 6, 12, 18, 24].map(function(score) {
                var y = padTop + plotH - (score / maxScore) * plotH;
                return '<text x="' + (padLeft - 8) + '" y="' + (y + 4) + '" text-anchor="end" fill="#999" font-size="11" font-family="-apple-system, BlinkMacSystemFont, sans-serif">' + score + '</text>' +
                       '<line x1="' + padLeft + '" y1="' + y + '" x2="' + (chartW - padRight) + '" y2="' + y + '" stroke="#eee" stroke-width="1"/>';
            }).join('');

            // Dots
            var dots = points.map(function(p) {
                var color = p.score >= 20 ? '#4caf50' : p.score >= 15 ? '#2196f3' : p.score >= 10 ? '#ff9800' : '#f44336';
                return '<circle cx="' + p.x.toFixed(1) + '" cy="' + p.y.toFixed(1) + '" r="5" fill="' + color + '" stroke="white" stroke-width="2"/>';
            }).join('');

            var svgChart =
                '<svg viewBox="0 0 ' + chartW + ' ' + chartH + '" class="chart-canvas">' +
                    yLabels +
                    '<path d="' + areaD + '" fill="rgba(102,126,234,0.1)" />' +
                    '<path d="' + pathD + '" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>' +
                    dots +
                '</svg>';

            container.innerHTML =
                '<div class="progress-chart-card">' +
                    '<div class="progress-chart-title">Your Score Progression</div>' +
                    '<p style="color: #666; font-size: 0.9em; margin-bottom: 5px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">Last ' + sessions.length + ' sessions (out of 24 possible points)</p>' +
                    '<div class="chart-container">' + svgChart + '</div>' +
                    '<div class="chart-legend">' +
                        '<div class="legend-item"><div class="legend-dot" style="background: #4caf50;"></div> 20+ Excellent</div>' +
                        '<div class="legend-item"><div class="legend-dot" style="background: #2196f3;"></div> 15-19 Good</div>' +
                        '<div class="legend-item"><div class="legend-dot" style="background: #ff9800;"></div> 10-14 Fair</div>' +
                        '<div class="legend-item"><div class="legend-dot" style="background: #f44336;"></div> &lt;10 Needs Work</div>' +
                    '</div>' +
                    streakHtml +
                '</div>';
        }

        // =============================================
        // Feature 10: Story Archive (localStorage)
        // =============================================

        function loadArchive() {
            try {
                var data = localStorage.getItem('uil-headline-archive');
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }

        function saveToArchive(stories, headlinesData, score, mode) {
            var archive = loadArchive();
            archive.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                stories: stories,
                headlines: headlinesData,
                score: score,
                mode: mode || 'practice'
            });
            // Keep last 50 stories
            if (archive.length > 50) archive = archive.slice(0, 50);
            try { localStorage.setItem('uil-headline-archive', JSON.stringify(archive)); } catch (e) {}
        }

        function renderArchive() {
            var container = document.getElementById('archive-section');
            if (!container) return;

            var archive = loadArchive();
            if (archive.length === 0) {
                container.innerHTML = '';
                return;
            }

            var recentItems = archive.slice(0, 8);
            var listHtml = recentItems.map(function(item) {
                var d = new Date(item.date);
                var dateStr = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                var firstStory = item.stories ? item.stories[0] : (item.story || '');
                var preview = firstStory ? firstStory.substring(0, 80) + '...' : 'No story text';
                var modeClass = item.mode || 'practice';

                return '<div class="archive-item" onclick="loadArchivedStory(' + item.id + ')">' +
                    '<div class="archive-item-info">' +
                        '<div class="archive-item-date">' + dateStr + ' <span class="archive-item-mode ' + modeClass + '">' + modeClass.toUpperCase() + '</span></div>' +
                        '<div class="archive-item-preview">' + preview + '</div>' +
                    '</div>' +
                    '<div class="archive-item-score">' + (item.score || '?') + '/24</div>' +
                '</div>';
            }).join('');

            container.innerHTML =
                '<div class="archive-card">' +
                    '<div class="archive-title">' +
                        'Story Archive' +
                        '<span class="archive-count">' + archive.length + ' stored</span>' +
                    '</div>' +
                    '<p style="color: #666; font-size: 0.9em; margin-bottom: 12px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">Click any past set to practice again with the same 6 stories.</p>' +
                    '<div class="archive-list">' + listHtml + '</div>' +
                    (archive.length > 8 ? '<p style="text-align: center; color: #999; font-size: 12px; margin-top: 10px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">Showing 8 of ' + archive.length + ' stories</p>' : '') +
                    '<div class="dashboard-actions" style="margin-top: 10px;">' +
                        '<button class="clear-data-btn" onclick="clearArchive()">Clear Archive</button>' +
                    '</div>' +
                '</div>';
        }

        function loadArchivedStory(id) {
            var archive = loadArchive();
            var item = archive.find(function(a) { return a.id === id; });
            if (!item) return;

            // Support old single-story format and new 6-story format
            if (item.stories && Array.isArray(item.stories)) {
                currentStories = item.stories;
            } else if (item.story) {
                // Legacy: single story — duplicate it for all 6 slots
                currentStories = [item.story, item.story, item.story, item.story, item.story, item.story];
            }
            selectedStoryCount = currentStories.length;
            displayStories();

            // Start timer for timed or mock modes
            if (currentMode === 'timed' || currentMode === 'mock') {
                startTimer();
            }

            document.getElementById('mode-selector').style.display = 'none';
            document.getElementById('story-count-selector').style.display = 'none';
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('archive-section').innerHTML = '';
        }

        function clearArchive() {
            if (confirm('Clear all archived stories? This cannot be undone.')) {
                localStorage.removeItem('uil-headline-archive');
                renderArchive();
            }
        }

        // =============================================
        // Core App Functions
        // =============================================

        async function generateStory() {
            var startBtn = event.target;
            startBtn.disabled = true;
            var count = selectedStoryCount;
            startBtn.textContent = 'Generating ' + count + ' stor' + (count === 1 ? 'y' : 'ies') + '...';

            try {
                var response = await fetch('/api/generate-story', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                var data = await response.json();

                if (data.error) throw new Error(data.error);

                if (data.stories && data.stories.length === 6) {
                    // Use only the selected number of stories
                    currentStories = data.stories.slice(0, count);
                    displayStories();

                    // Start timer for timed or mock modes
                    if (currentMode === 'timed' || currentMode === 'mock') {
                        startTimer();
                    }

                    document.getElementById('mode-selector').style.display = 'none';
                    document.getElementById('story-count-selector').style.display = 'none';
                    document.getElementById('archive-section').innerHTML = '';
                } else {
                    throw new Error('Failed to parse stories');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating stories. Please try again.');
                startBtn.disabled = false;
                startBtn.textContent = 'Generate New Stories';
            }
        }

        function displayStories() {
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('story-section').style.display = 'block';

            var pairsDiv = document.getElementById('story-headline-pairs');
            pairsDiv.innerHTML = '';

            // Mock contest banner at top
            if (currentMode === 'mock') {
                var mockBanner = document.createElement('div');
                mockBanner.style.cssText = 'text-align: center; margin-bottom: 20px;';
                mockBanner.innerHTML = '<span class="mock-badge" style="font-size: 14px; padding: 6px 16px;">MOCK CONTEST</span>';
                pairsDiv.appendChild(mockBanner);
            }

            currentStories.forEach(function(storyText, index) {
                var req = headlineRequirements[index];

                // Story block
                var storyBlock = document.createElement('div');
                storyBlock.className = 'story-section';
                storyBlock.innerHTML =
                    '<div class="story-header">' +
                        '<div class="story-title">Story ' + (index + 1) + '</div>' +
                    '</div>' +
                    '<div class="story-text">' + storyText + '</div>';
                pairsDiv.appendChild(storyBlock);

                // Headline input section directly below its story
                var section = document.createElement('div');
                section.className = 'headline-input-section';

                var label = document.createElement('label');
                label.className = 'headline-label';
                label.textContent = 'Headline ' + (index + 1) + ' — ' + req.label;
                section.appendChild(label);

                if (req.type === 'main+secondary') {
                    for (var mLine = 0; mLine < req.mainLines; mLine++) {
                        buildLineInput(section, index, mLine, req.mainMin, req.mainMax, 'Main headline:', 'main headline');
                    }
                    for (var sLine = 0; sLine < req.secLines; sLine++) {
                        var lineIdx = req.mainLines + sLine;
                        buildLineInput(section, index, lineIdx, req.secMin, req.secMax, 'Secondary headline' + (req.secLines > 1 ? ' line ' + (sLine + 1) + ':' : ':'), 'secondary headline');
                    }
                } else {
                    for (var line = 0; line < req.lines; line++) {
                        var lineLabel = req.lines === 1 ? 'Headline:' : (line === 0 ? 'Line 1:' : 'Line ' + (line + 1) + ':');
                        buildLineInput(section, index, line, req.minCount, req.maxCount, lineLabel, 'line ' + (line + 1));
                    }
                }

                pairsDiv.appendChild(section);

                // Add a visual separator between story-headline pairs (except after the last one)
                if (index < 5) {
                    var separator = document.createElement('hr');
                    separator.style.cssText = 'border: none; border-top: 3px solid #667eea; margin: 30px 0; opacity: 0.3;';
                    pairsDiv.appendChild(separator);
                }
            });
        }

        function buildLineInput(section, index, lineNum, minCount, maxCount, labelText, placeholder) {
            var lineLabel = document.createElement('div');
            lineLabel.style.fontSize = '13px';
            lineLabel.style.color = '#666';
            lineLabel.style.marginTop = lineNum > 0 ? '15px' : '10px';
            lineLabel.style.marginBottom = '8px';
            lineLabel.textContent = labelText;
            section.appendChild(lineLabel);

            var grid = document.createElement('div');
            grid.className = 'character-grid';
            grid.id = 'grid-' + index + '-' + lineNum;
            for (var i = 0; i < maxCount; i++) {
                var box = document.createElement('div');
                box.className = 'char-box';
                box.textContent = String(i + 1);
                grid.appendChild(box);
            }
            section.appendChild(grid);

            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'headline-input';
            input.id = 'headline-' + index + '-' + lineNum;
            input.placeholder = 'Enter your ' + placeholder + '...';
            input.setAttribute('data-headline-index', index);
            input.setAttribute('data-line', lineNum);
            input.setAttribute('data-min', minCount);
            input.setAttribute('data-max', maxCount);
            input.addEventListener('input', updateCharacterCount);
            section.appendChild(input);

            var countDiv = document.createElement('div');
            countDiv.className = 'char-count';
            countDiv.id = 'count-' + index + '-' + lineNum;
            countDiv.textContent = '0 / ' + minCount + '-' + maxCount + ' characters';
            section.appendChild(countDiv);

            // Feature 1: Violations container (hidden in mock mode)
            var violationsDiv = document.createElement('div');
            violationsDiv.className = 'violations-container';
            violationsDiv.id = 'violations-' + index + '-' + lineNum;
            if (currentMode === 'mock') violationsDiv.style.display = 'none';
            section.appendChild(violationsDiv);
        }

        function updateCharacterCount(event) {
            var input = event.target;
            var index = input.getAttribute('data-headline-index');
            var line = input.getAttribute('data-line');
            var minCount = parseInt(input.getAttribute('data-min'));
            var maxCount = parseInt(input.getAttribute('data-max'));
            var value = input.value;
            var count = value.length;

            var countDiv = document.getElementById('count-' + index + '-' + line);
            countDiv.textContent = count + ' / ' + minCount + '-' + maxCount + ' characters';

            if (count < minCount || count > maxCount) {
                countDiv.classList.add('warning');
            } else {
                countDiv.classList.remove('warning');
            }

            var grid = document.getElementById('grid-' + index + '-' + line);
            var boxes = grid.querySelectorAll('.char-box');
            boxes.forEach(function(box, i) {
                box.classList.remove('filled', 'over-limit');
                if (i < count) {
                    if (i < maxCount) {
                        box.classList.add('filled');
                        box.textContent = value[i];
                    } else {
                        box.classList.add('over-limit');
                        box.textContent = value[i];
                    }
                } else {
                    box.textContent = String(i + 1);
                }
            });

            // Feature 1: Check and render violations (not in mock mode)
            if (currentMode !== 'mock') {
                var violations = checkViolations(value);
                renderViolations(violations, 'violations-' + index + '-' + line);
            }
        }

        async function submitHeadlines(skipValidation) {
            stopTimer();

            headlines = [];
            var allValid = true;

            var activeCount = currentStories.length;
            for (var index = 0; index < activeCount; index++) {
                var req = headlineRequirements[index];
                var headlineLines = [];
                var totalLines;
                if (req.type === 'main+secondary') {
                    totalLines = req.mainLines + req.secLines;
                    for (var m = 0; m < req.mainLines; m++) {
                        var input = document.getElementById('headline-' + index + '-' + m);
                        var value = input.value.trim();
                        if (!value) allValid = false;
                        headlineLines.push({ text: value, charCount: value.length, minRequired: req.mainMin, maxRequired: req.mainMax, role: 'main' });
                    }
                    for (var s = 0; s < req.secLines; s++) {
                        var lineIdx = req.mainLines + s;
                        var input2 = document.getElementById('headline-' + index + '-' + lineIdx);
                        var value2 = input2.value.trim();
                        if (!value2) allValid = false;
                        headlineLines.push({ text: value2, charCount: value2.length, minRequired: req.secMin, maxRequired: req.secMax, role: 'secondary' });
                    }
                } else {
                    totalLines = req.lines;
                    for (var line = 0; line < req.lines; line++) {
                        var input3 = document.getElementById('headline-' + index + '-' + line);
                        var value3 = input3.value.trim();
                        if (!value3) allValid = false;
                        headlineLines.push({ text: value3, charCount: value3.length, minRequired: req.minCount, maxRequired: req.maxCount });
                    }
                }
                headlines.push({
                    headlineNumber: index + 1,
                    lines: headlineLines,
                    totalLines: totalLines,
                    type: req.type || 'single',
                    label: req.label
                });
            }

            if (!allValid && !skipValidation) {
                alert('Please fill in all headline fields before submitting.');
                return;
            }

            document.getElementById('submit-btn').disabled = true;
            document.getElementById('story-section').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                await evaluateHeadlines();
            } catch (error) {
                alert('Error evaluating headlines. Please try again.');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('story-section').style.display = 'block';
                document.getElementById('submit-btn').disabled = false;
            }
        }

        async function evaluateHeadlines() {
            try {
                var response = await fetch('/api/evaluate-headlines', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stories: currentStories, headlines: headlines })
                });

                var data = await response.json();
                if (data.error) throw new Error(data.error);

                // Feature 5: Record session before displaying
                recordSession(data);

                // Feature 10: Save stories + headlines to archive
                var headlineTexts = headlines.map(function(h) {
                    return h.lines.map(function(l) { return l.text; }).join(' / ');
                });
                saveToArchive(currentStories, headlineTexts, data.overallScore, currentMode);

                displayFeedback(data);
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        function displayFeedback(evaluation) {
            lastEvaluation = evaluation; // Store for copy/export/share
            document.getElementById('loading').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';

            var feedbackDiv = document.getElementById('feedback-content');
            feedbackDiv.innerHTML = '';

            // Overall score card
            var overallCard = document.createElement('div');
            overallCard.className = 'feedback-card';

            var maxPossible = currentStories.length * 4;
            var scoreClass = evaluation.overallScore >= (maxPossible * 0.83) ? 'excellent' :
                            evaluation.overallScore >= (maxPossible * 0.62) ? 'good' :
                            evaluation.overallScore >= (maxPossible * 0.42) ? 'fair' : 'needs-work';

            overallCard.innerHTML =
                '<div class="feedback-headline">Overall Performance' +
                (currentMode === 'mock' ? ' <span class="mock-badge">MOCK CONTEST</span>' : '') +
                '</div>' +
                '<div class="score ' + scoreClass + '">Score: ' + evaluation.overallScore + '/' + maxPossible + '</div>' +
                '<div class="feedback-text">' + evaluation.overallFeedback + '</div>';
            feedbackDiv.appendChild(overallCard);

            // Individual headline feedback
            evaluation.headlines.forEach(function(hl, index) {
                var card = document.createElement('div');
                card.className = 'feedback-card';

                var studentHeadline = headlines[index].lines.map(function(l) { return l.text; }).join('<br>');

                var scoreClass = hl.score === 4 ? 'excellent' :
                                hl.score === 3 ? 'good' :
                                hl.score === 2 || hl.score === 1 ? 'fair' : 'needs-work';

                var html =
                    '<div class="feedback-headline">Headline ' + hl.number + '</div>' +
                    '<div class="score ' + scoreClass + '">Score: ' + hl.score + '/4</div>';

                // Feature 6: Side-by-Side Comparison
                if (hl.suggestedRevision) {
                    html +=
                        '<div class="comparison-row">' +
                            '<div class="comparison-col yours">' +
                                '<div class="comparison-label">Your Headline</div>' +
                                studentHeadline +
                            '</div>' +
                            '<div class="comparison-col suggested">' +
                                '<div class="comparison-label">Suggested Revision</div>' +
                                hl.suggestedRevision +
                            '</div>' +
                        '</div>';
                } else {
                    html += '<div class="your-headline">' + studentHeadline + '</div>';
                }

                if (hl.strengths && hl.strengths.length > 0) {
                    html +=
                        '<div class="strength">' +
                            '<strong>Strengths:</strong>' +
                            '<ul class="feedback-list">' +
                                hl.strengths.map(function(s) { return '<li>' + s + '</li>'; }).join('') +
                            '</ul>' +
                        '</div>';
                }

                if (hl.improvements && hl.improvements.length > 0) {
                    html +=
                        '<div class="improvement">' +
                            '<strong>Areas for Improvement:</strong>' +
                            '<ul class="feedback-list">' +
                                hl.improvements.map(function(i) { return '<li>' + i + '</li>'; }).join('') +
                            '</ul>' +
                        '</div>';
                }

                html += '<div class="feedback-text" style="margin-top: 15px;">' + hl.feedback + '</div>';

                card.innerHTML = html;
                feedbackDiv.appendChild(card);
            });

            // Feature 14: Render score breakdown by headline type
            renderBreakdown(evaluation);

            // Feature 9: Render progress chart
            renderProgressChart();

            // Feature 5: Render weakness dashboard
            renderDashboard();
        }

        function resetApp() {
            stopTimer();
            timeRemaining = 1800;
            document.getElementById('timer-bar').className = 'timer-bar';
            document.getElementById('time-up-overlay').classList.remove('visible');
            document.getElementById('mode-selector').style.display = 'flex';
            document.getElementById('story-count-selector').style.display = 'flex';
            document.getElementById('dashboard-container').innerHTML = '';
            document.getElementById('progress-chart-container').innerHTML = '';
            document.getElementById('breakdown-container').innerHTML = '';

            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('start-section').style.display = 'block';
            document.getElementById('submit-btn').disabled = false;
            currentStories = [];
            headlines = [];

            var startBtn = document.getElementById('generate-btn');
            startBtn.disabled = false;
            setStoryCount(selectedStoryCount); // Restore button text

            // Feature 10: Re-render story archive on start screen
            renderArchive();
        }

        // =============================================
        // Feature 12: Dark Mode
        // =============================================

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            var isDark = document.body.classList.contains('dark-mode');
            document.getElementById('dark-toggle').textContent = isDark ? 'Light Mode' : 'Dark Mode';
            try { localStorage.setItem('uil-dark-mode', isDark ? '1' : '0'); } catch (e) {}
        }

        function loadDarkMode() {
            try {
                if (localStorage.getItem('uil-dark-mode') === '1') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-toggle').textContent = 'Light Mode';
                }
            } catch (e) {}
        }

        // =============================================
        // Feature 14: Score Breakdown by Headline Type
        // =============================================

        function renderBreakdown(evaluation) {
            var container = document.getElementById('breakdown-container');
            if (!container || !evaluation.headlines) { container.innerHTML = ''; return; }

            // Categorize scores by headline type
            var activeCount = selectedStoryCount;
            var types = { '1-line': [], '2-line': [], '3-line': [], 'main+sec': [] };

            evaluation.headlines.forEach(function(hl, i) {
                if (i >= activeCount) return;
                var req = headlineRequirements[i];
                if (req.type === 'main+secondary') types['main+sec'].push(hl.score);
                else if (req.lines === 1) types['1-line'].push(hl.score);
                else if (req.lines === 2) types['2-line'].push(hl.score);
                else if (req.lines === 3) types['3-line'].push(hl.score);
            });

            var itemsHtml = '';
            var typeLabels = { '1-line': '1-Line', '2-line': '2-Line', '3-line': '3-Line', 'main+sec': 'Main + Sec' };
            var typeColors = { '1-line': '#4caf50', '2-line': '#2196f3', '3-line': '#ff9800', 'main+sec': '#9c27b0' };

            Object.keys(types).forEach(function(key) {
                var scores = types[key];
                if (scores.length === 0) return;
                var avg = (scores.reduce(function(s, v) { return s + v; }, 0) / scores.length).toFixed(1);
                var total = scores.reduce(function(s, v) { return s + v; }, 0);

                itemsHtml +=
                    '<div class="breakdown-item">' +
                        '<div class="breakdown-type-label">' + typeLabels[key] + '</div>' +
                        '<div class="breakdown-score" style="color: ' + typeColors[key] + ';">' + avg + '</div>' +
                        '<div class="breakdown-max">' + total + '/' + (scores.length * 4) + ' pts (' + scores.length + ' headline' + (scores.length > 1 ? 's' : '') + ')</div>' +
                    '</div>';
            });

            // Also show historical breakdown
            var history = loadHistory();
            var historyHtml = '';
            if (history.sessions.length >= 3) {
                // Calculate historical per-type averages from weakness categories
                var totalAvg = (history.sessions.reduce(function(s, sess) { return s + sess.score; }, 0) / history.sessions.length).toFixed(1);
                var maxPossible = activeCount * 4;
                historyHtml =
                    '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">' +
                        '<div style="font-size: 12px; color: #999; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">' +
                            'Lifetime average: <strong style="color: #667eea;">' + totalAvg + '/' + maxPossible + '</strong> across ' + history.sessions.length + ' sessions' +
                        '</div>' +
                    '</div>';
            }

            container.innerHTML =
                '<div class="breakdown-card">' +
                    '<div class="breakdown-title">Score Breakdown by Headline Type</div>' +
                    '<div class="breakdown-grid">' + itemsHtml + '</div>' +
                    historyHtml +
                '</div>';
        }

        // =============================================
        // Feature 15: Quick Practice (Story Count)
        // =============================================

        var selectedStoryCount = 6;

        function setStoryCount(count) {
            selectedStoryCount = count;
            // Update active button
            document.querySelectorAll('.story-count-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === count || (btn.textContent.includes('UIL') && count === 6)) {
                    btn.classList.add('active');
                }
            });
            // Update generate button text
            var genBtn = document.getElementById('generate-btn');
            if (genBtn) {
                if (count === 6) genBtn.textContent = 'Generate 6 Stories (UIL Format)';
                else if (count === 1) genBtn.textContent = 'Generate 1 Story (Quick Practice)';
                else genBtn.textContent = 'Generate ' + count + ' Stories';
            }
        }

        // =============================================
        // Feature 16: Coach Sharing Tools
        // =============================================

        var lastEvaluation = null;

        function showToast(message) {
            var toast = document.getElementById('copied-toast');
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(function() { toast.classList.remove('visible'); }, 2500);
        }

        // --- Copy Results to Clipboard (plain text summary) ---
        function copyResultsToClipboard() {
            if (!lastEvaluation) { showToast('No results to copy'); return; }
            var eval = lastEvaluation;
            var maxPossible = currentStories.length * 4;
            var text = '=== UIL Headline Writing Results ===\n';
            text += 'Date: ' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString() + '\n';
            text += 'Mode: ' + currentMode.toUpperCase() + '\n';
            text += 'Stories: ' + currentStories.length + '\n';
            text += 'Overall Score: ' + eval.overallScore + '/' + maxPossible + '\n';
            text += 'Overall Feedback: ' + eval.overallFeedback + '\n\n';

            eval.headlines.forEach(function(hl, i) {
                var studentHL = headlines[i] ? headlines[i].lines.map(function(l) { return l.text; }).join(' / ') : '';
                text += '--- Headline ' + hl.number + ' (Score: ' + hl.score + '/4) ---\n';
                text += 'Student: ' + studentHL + '\n';
                if (hl.strengths && hl.strengths.length > 0) {
                    text += 'Strengths: ' + hl.strengths.join('; ') + '\n';
                }
                if (hl.improvements && hl.improvements.length > 0) {
                    text += 'Improvements: ' + hl.improvements.join('; ') + '\n';
                }
                if (hl.suggestedRevision) {
                    text += 'Suggested: ' + hl.suggestedRevision + '\n';
                }
                text += 'Feedback: ' + hl.feedback + '\n\n';
            });

            navigator.clipboard.writeText(text).then(function() {
                showToast('Results copied to clipboard!');
            }).catch(function() {
                // Fallback for older browsers
                var textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Results copied to clipboard!');
            });
        }

        // --- Export CSV ---
        function exportCSV() {
            if (!lastEvaluation) { showToast('No results to export'); return; }
            var eval = lastEvaluation;

            var rows = [['Headline #', 'Type', 'Student Headline', 'Score', 'Strengths', 'Improvements', 'Suggested Revision', 'Feedback']];

            eval.headlines.forEach(function(hl, i) {
                var studentHL = headlines[i] ? headlines[i].lines.map(function(l) { return l.text; }).join(' / ') : '';
                var req = headlineRequirements[i];
                var typeLabel = req ? (req.type === 'main+secondary' ? 'Main+Secondary' : req.lines + '-Line') : '';
                rows.push([
                    hl.number,
                    typeLabel,
                    '"' + studentHL.replace(/"/g, '""') + '"',
                    hl.score + '/4',
                    '"' + (hl.strengths || []).join('; ').replace(/"/g, '""') + '"',
                    '"' + (hl.improvements || []).join('; ').replace(/"/g, '""') + '"',
                    '"' + (hl.suggestedRevision || '').replace(/"/g, '""') + '"',
                    '"' + (hl.feedback || '').replace(/"/g, '""') + '"'
                ]);
            });

            // Add summary row
            var maxPossible = currentStories.length * 4;
            rows.push([]);
            rows.push(['TOTAL', '', '', eval.overallScore + '/' + maxPossible, '', '', '', '"' + (eval.overallFeedback || '').replace(/"/g, '""') + '"']);
            rows.push(['Date', new Date().toLocaleDateString(), 'Mode', currentMode.toUpperCase()]);

            var csvContent = rows.map(function(row) { return row.join(','); }).join('\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'uil-headline-results-' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            URL.revokeObjectURL(link.href);
            showToast('CSV downloaded!');
        }

        // --- Share with Coach (generates a compact encoded result code) ---
        function openShareModal() {
            if (!lastEvaluation) { showToast('No results to share'); return; }
            document.getElementById('share-modal-overlay').classList.add('visible');
            document.getElementById('share-code-box').textContent = 'Enter your name and click "Generate Code"';
            document.getElementById('generate-share-btn').style.display = '';
            document.getElementById('copy-share-btn').style.display = 'none';
        }

        function closeShareModal(event) {
            if (event.target === event.currentTarget) {
                document.getElementById('share-modal-overlay').classList.remove('visible');
            }
        }

        function generateShareCode() {
            var studentName = document.getElementById('student-name-input').value.trim();
            if (!studentName) {
                document.getElementById('student-name-input').style.borderColor = '#f44336';
                document.getElementById('student-name-input').focus();
                return;
            }
            document.getElementById('student-name-input').style.borderColor = '#ddd';

            var shareData = {
                v: 1, // version
                name: studentName,
                date: new Date().toISOString(),
                mode: currentMode,
                storyCount: currentStories.length,
                overall: lastEvaluation.overallScore,
                max: currentStories.length * 4,
                overallFeedback: lastEvaluation.overallFeedback,
                hl: lastEvaluation.headlines.map(function(h, i) {
                    var studentHL = headlines[i] ? headlines[i].lines.map(function(l) { return l.text; }).join(' / ') : '';
                    var req = headlineRequirements[i];
                    return {
                        n: h.number,
                        t: req ? (req.type === 'main+secondary' ? 'M+S' : req.lines + 'L') : '?',
                        s: h.score,
                        sh: studentHL,
                        sr: h.suggestedRevision || null,
                        st: h.strengths || [],
                        im: h.improvements || [],
                        fb: h.feedback
                    };
                })
            };

            var jsonStr = JSON.stringify(shareData);
            var encoded = btoa(unescape(encodeURIComponent(jsonStr)));
            var code = 'UIL:' + encoded;

            document.getElementById('share-code-box').textContent = code;
            document.getElementById('generate-share-btn').style.display = 'none';
            document.getElementById('copy-share-btn').style.display = '';
        }

        function copyShareCode() {
            var code = document.getElementById('share-code-box').textContent;
            navigator.clipboard.writeText(code).then(function() {
                showToast('Share code copied! Send this to your coach.');
            }).catch(function() {
                var textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Share code copied! Send this to your coach.');
            });
        }

        // Render archive on initial page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDarkMode();
            renderArchive();
        });
    </script>
</body>
</html>
