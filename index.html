<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIL Headline Writing Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .story-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .story-title {
            font-size: 1.3em;
            color: #1e3c72;
            font-weight: bold;
        }

        .story-text {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }

        .headline-input-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .headline-label {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
            display: block;
        }

        .character-grid {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .char-box {
            width: 24px;
            height: 32px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-family: monospace;
            font-size: 14px;
        }

        .char-box.filled {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .char-box.over-limit {
            background: #ffebee;
            border-color: #f44336;
        }

        .headline-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: Georgia, serif;
            margin-bottom: 8px;
        }

        .headline-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #f44336;
            font-weight: bold;
        }

        .submit-section {
            text-align: center;
            margin: 30px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feedback-section {
            display: none;
            margin-top: 30px;
        }

        .feedback-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feedback-headline {
            font-size: 1.2em;
            color: #1e3c72;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .your-headline {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: Georgia, serif;
            font-size: 1.1em;
        }

        .score {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .score.excellent {
            background: #4caf50;
            color: white;
        }

        .score.good {
            background: #2196f3;
            color: white;
        }

        .score.fair {
            background: #ff9800;
            color: white;
        }

        .score.needs-work {
            background: #f44336;
            color: white;
        }

        .feedback-text {
            line-height: 1.6;
            color: #444;
            margin: 10px 0;
        }

        .feedback-list {
            margin: 15px 0;
            padding-left: 20px;
        }

        .feedback-list li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .improvement {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .strength {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .try-again-btn {
            margin-top: 30px;
            text-align: center;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box strong {
            color: #1976d2;
        }

        /* --- Feature 1: Rule Violation Highlighting --- */
        .violations-container {
            margin-top: 6px;
            min-height: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .violation-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }

        .violation-tag.article {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .violation-tag.past-tense {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .violation-tag.passive-voice {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .violation-tag.l-word {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .violation-tag.punctuation {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .violation-tag.name-issue {
            background: #e2d5f1;
            color: #4a235a;
            border: 1px solid #d2b4de;
        }

        /* --- Feature 2: Timed Practice Mode --- */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0 10px;
        }

        .mode-btn {
            padding: 10px 24px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: Georgia, serif;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: #f0f0ff;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .timer-bar {
            display: none;
            background: #1e3c72;
            color: white;
            text-align: center;
            padding: 12px 20px;
            font-size: 1.6em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-radius: 12px 12px 0 0;
        }

        .timer-bar.visible {
            display: block;
        }

        .timer-bar.warning-10 {
            background: #e67e22;
        }

        .timer-bar.warning-5 {
            background: #e74c3c;
            animation: pulse 1s ease-in-out infinite;
        }

        .timer-bar.warning-1 {
            background: #c0392b;
            animation: pulse 0.5s ease-in-out infinite;
        }

        .timer-bar.expired {
            background: #7f8c8d;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .time-up-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .time-up-overlay.visible {
            display: flex;
        }

        .time-up-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .time-up-card h2 {
            font-size: 2em;
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .time-up-card p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.6em;
            }

            .content {
                padding: 20px;
            }

            .char-box {
                width: 20px;
                height: 28px;
                font-size: 12px;
            }

            .mode-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .mode-btn {
                text-align: center;
            }

            .timer-bar {
                font-size: 1.3em;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="timer-bar" id="timer-bar">30:00</div>

        <div class="header">
            <h1>UIL Headline Writing Trainer</h1>
            <p>Practice writing headlines with AI-powered feedback</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>How it works:</strong> You'll receive a randomly generated news story. Write headlines following UIL rules, then get detailed AI feedback to improve your skills!
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2196f3;">
                    <strong>New to UIL Headline Writing?</strong> <a href="tutorial.html" style="color: #1976d2; text-decoration: underline;">Start with our beginner tutorial</a>
                    <span style="margin: 0 8px; color: #999;">|</span>
                    <strong>Target Your Weaknesses:</strong> <a href="drills.html" style="color: #1976d2; text-decoration: underline;">Try skill drills</a>
                </div>
            </div>

            <div class="mode-selector" id="mode-selector">
                <button class="mode-btn active" onclick="setMode('practice')" id="mode-practice">Practice Mode</button>
                <button class="mode-btn" onclick="setMode('timed')" id="mode-timed">Timed Mode (30 min)</button>
            </div>

            <div id="start-section">
                <div style="text-align: center; padding: 40px 0;">
                    <button class="btn" onclick="generateStory()">Generate New Story</button>
                </div>
            </div>

            <div id="story-section" style="display: none;">
                <div class="story-section">
                    <div class="story-header">
                        <div class="story-title" id="story-title">Story</div>
                    </div>
                    <div class="story-text" id="story-text"></div>
                </div>

                <div id="headline-assignments"></div>

                <div class="submit-section">
                    <button class="btn" onclick="submitHeadlines()" id="submit-btn">Submit for Feedback</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your headlines...</p>
            </div>

            <div class="feedback-section" id="feedback-section">
                <div id="feedback-content"></div>
                <div class="try-again-btn">
                    <button class="btn" onclick="resetApp()">Try Another Story</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time's Up Overlay -->
    <div class="time-up-overlay" id="time-up-overlay">
        <div class="time-up-card">
            <h2>Time's Up!</h2>
            <p>Your 30 minutes have expired.</p>
            <p style="font-size: 0.95em; color: #999;">You can submit what you have or keep editing without the timer.</p>
            <button class="btn" onclick="submitAfterTimeout()" style="margin-top: 20px;">Submit My Headlines</button>
            <br>
            <button class="btn" onclick="dismissTimeout()" style="margin-top: 10px; background: #6c757d;">Keep Editing (Untimed)</button>
        </div>
    </div>

    <script>
        let currentStory = null;
        let headlines = [];

        // Feature 2: Timer state
        let timedMode = false;
        let timerInterval = null;
        let timeRemaining = 1800; // 30 minutes in seconds
        let timerRunning = false;

        const headlineRequirements = [
            { lines: 1, minCount: 24, maxCount: 30 },
            { lines: 2, minCount: 24, maxCount: 30 },
            { lines: 3, minCount: 20, maxCount: 26 },
            { lines: 1, minCount: 10, maxCount: 16 },
            { lines: 2, minCount: 20, maxCount: 26 },
            { lines: 1, minCount: 24, maxCount: 30 }
        ];

        // =============================================
        // Feature 1: Rule Violation Detection
        // =============================================

        const IRREGULAR_PAST = new Set([
            'won', 'said', 'told', 'went', 'came', 'made', 'took',
            'gave', 'found', 'knew', 'thought', 'got', 'saw', 'ran',
            'began', 'left', 'brought', 'held', 'wrote', 'stood',
            'lost', 'paid', 'met', 'spent', 'built', 'sent',
            'fell', 'felt', 'kept', 'became', 'grew', 'drew', 'broke',
            'spoke', 'chose', 'rose', 'drove', 'rode', 'wore', 'flew',
            'sang', 'swam', 'threw', 'caught', 'taught', 'fought',
            'bought', 'led', 'was', 'were', 'had', 'did'
        ]);

        const NOT_PAST_TENSE = new Set([
            'bed', 'red', 'fed', 'shed', 'sled', 'wed',
            'hundred', 'sacred', 'wicked', 'naked', 'speed',
            'need', 'seed', 'feed', 'freed', 'breed', 'agreed',
            'guaranteed', 'proceed', 'succeed', 'indeed'
        ]);

        const COMMON_NON_NAME_PHRASES = new Set([
            'new york', 'high school', 'student council', 'national honor',
            'honor society', 'spring break', 'fall semester', 'summer camp',
            'state championship', 'school board', 'school district',
            'middle school', 'junior varsity', 'varsity football',
            'north texas', 'south texas', 'east texas', 'west texas',
            'red cross', 'boy scouts', 'girl scouts', 'united states',
            'first place', 'second place', 'third place'
        ]);

        function checkViolations(text) {
            const violations = [];
            if (!text.trim()) return violations;

            // 1. Articles
            const articleRegex = /\b(a|an|the)\b/gi;
            let match;
            while ((match = articleRegex.exec(text)) !== null) {
                violations.push({ type: 'article', label: 'Article: "' + match[0] + '"' });
            }

            // 2. Past tense: -ed endings
            const edRegex = /\b(\w{3,}ed)\b/gi;
            while ((match = edRegex.exec(text)) !== null) {
                const word = match[1].toLowerCase();
                if (!NOT_PAST_TENSE.has(word)) {
                    violations.push({ type: 'past-tense', label: 'Past tense? "' + match[1] + '"' });
                }
            }

            // 3. Past tense: irregular verbs
            const irregularRegex = new RegExp('\\b(' + Array.from(IRREGULAR_PAST).join('|') + ')\\b', 'gi');
            while ((match = irregularRegex.exec(text)) !== null) {
                violations.push({ type: 'past-tense', label: 'Past tense: "' + match[1] + '"' });
            }

            // 4. Passive voice: be-verb + past participle
            const passiveRegex = /\b(is|are|was|were|been|being|be)\s+(\w+ed|\w+en)\b/gi;
            while ((match = passiveRegex.exec(text)) !== null) {
                violations.push({ type: 'passive-voice', label: 'Passive: "' + match[0] + '"' });
            }

            // 5. L-words
            const lWordRegex = /\b(leaguetown|lhs|our\s+school)\b/gi;
            while ((match = lWordRegex.exec(text)) !== null) {
                violations.push({ type: 'l-word', label: 'L-word: "' + match[0] + '"' });
            }

            // 6. Punctuation issues
            const punctRegex = /[?!&]/g;
            while ((match = punctRegex.exec(text)) !== null) {
                const labels = { '?': 'Question mark', '!': 'Exclamation mark', '&': 'Ampersand' };
                violations.push({ type: 'punctuation', label: labels[match[0]] });
            }

            // 7. First + Last name detection (two consecutive capitalized words)
            const nameRegex = /\b([A-Z][a-z]+)\s+([A-Z][a-z]+)\b/g;
            while ((match = nameRegex.exec(text)) !== null) {
                const phrase = match[1] + ' ' + match[2];
                if (!COMMON_NON_NAME_PHRASES.has(phrase.toLowerCase())) {
                    violations.push({ type: 'name-issue', label: 'Full name? "' + phrase + '"' });
                }
            }

            return violations;
        }

        function renderViolations(violations, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            const seen = new Set();
            violations.forEach(function(v) {
                if (seen.has(v.label)) return;
                seen.add(v.label);

                const tag = document.createElement('span');
                tag.className = 'violation-tag ' + v.type;
                tag.textContent = v.label;
                container.appendChild(tag);
            });
        }

        // =============================================
        // Feature 2: Timed Practice Mode
        // =============================================

        function setMode(mode) {
            timedMode = (mode === 'timed');
            document.getElementById('mode-practice').classList.toggle('active', !timedMode);
            document.getElementById('mode-timed').classList.toggle('active', timedMode);

            if (!timedMode && timerRunning) {
                stopTimer();
                document.getElementById('timer-bar').className = 'timer-bar';
            }
        }

        function startTimer() {
            timeRemaining = 1800;
            timerRunning = true;
            var timerBar = document.getElementById('timer-bar');
            timerBar.className = 'timer-bar visible';
            updateTimerDisplay();

            timerInterval = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();

                var timerBar = document.getElementById('timer-bar');
                if (timeRemaining <= 60) {
                    timerBar.className = 'timer-bar visible warning-1';
                } else if (timeRemaining <= 300) {
                    timerBar.className = 'timer-bar visible warning-5';
                } else if (timeRemaining <= 600) {
                    timerBar.className = 'timer-bar visible warning-10';
                }

                if (timeRemaining <= 0) {
                    stopTimer();
                    handleTimeExpired();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            var minutes = Math.floor(timeRemaining / 60);
            var seconds = timeRemaining % 60;
            var display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            document.getElementById('timer-bar').textContent = display;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
        }

        function handleTimeExpired() {
            var timerBar = document.getElementById('timer-bar');
            timerBar.className = 'timer-bar visible expired';
            timerBar.textContent = "TIME'S UP";

            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = true;
                input.style.opacity = '0.7';
                input.style.backgroundColor = '#f5f5f5';
            });

            document.getElementById('time-up-overlay').classList.add('visible');
        }

        function submitAfterTimeout() {
            document.getElementById('time-up-overlay').classList.remove('visible');

            // Re-enable inputs briefly for submission to read values
            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = false;
                input.style.opacity = '';
                input.style.backgroundColor = '';
            });

            submitHeadlines(true);
        }

        function dismissTimeout() {
            document.getElementById('time-up-overlay').classList.remove('visible');
            document.getElementById('timer-bar').className = 'timer-bar';

            document.querySelectorAll('.headline-input').forEach(function(input) {
                input.disabled = false;
                input.style.opacity = '';
                input.style.backgroundColor = '';
            });

            setMode('practice');
        }

        // =============================================
        // Core App Functions (with Feature 1 & 2 hooks)
        // =============================================

        async function generateStory() {
            const startBtn = event.target;
            startBtn.disabled = true;
            startBtn.textContent = 'Generating story...';

            try {
                const response = await fetch('/api/generate-story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.story) {
                    currentStory = data.story;
                    displayStory();

                    // Feature 2: Start timer if in timed mode
                    if (timedMode) {
                        startTimer();
                    }

                    // Hide mode selector once story is loaded
                    document.getElementById('mode-selector').style.display = 'none';
                } else {
                    throw new Error('Failed to parse story');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating story. Please try again.');
                startBtn.disabled = false;
                startBtn.textContent = 'Generate New Story';
            }
        }

        function displayStory() {
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('story-section').style.display = 'block';
            document.getElementById('story-text').textContent = currentStory;

            const assignmentsDiv = document.getElementById('headline-assignments');
            assignmentsDiv.innerHTML = '';

            headlineRequirements.forEach((req, index) => {
                const section = document.createElement('div');
                section.className = 'headline-input-section';

                const label = document.createElement('label');
                label.className = 'headline-label';
                label.textContent = `Headline ${index + 1} - ${req.lines}-line headline (${req.minCount}-${req.maxCount} characters per line)`;
                section.appendChild(label);

                for (let line = 0; line < req.lines; line++) {
                    const lineLabel = document.createElement('div');
                    lineLabel.style.fontSize = '13px';
                    lineLabel.style.color = '#666';
                    lineLabel.style.marginTop = line > 0 ? '15px' : '10px';
                    lineLabel.style.marginBottom = '8px';
                    lineLabel.textContent = req.lines > 1 ? (line === 0 ? 'Main headline:' : 'Secondary headline:') : 'Headline:';
                    section.appendChild(lineLabel);

                    const grid = document.createElement('div');
                    grid.className = 'character-grid';
                    grid.id = `grid-${index}-${line}`;
                    for (let i = 0; i < req.maxCount; i++) {
                        const box = document.createElement('div');
                        box.className = 'char-box';
                        box.textContent = String(i + 1);
                        grid.appendChild(box);
                    }
                    section.appendChild(grid);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'headline-input';
                    input.id = `headline-${index}-${line}`;
                    input.placeholder = `Enter your ${req.lines > 1 && line > 0 ? 'secondary' : 'main'} headline...`;
                    input.setAttribute('data-headline-index', index);
                    input.setAttribute('data-line', line);
                    input.addEventListener('input', updateCharacterCount);
                    section.appendChild(input);

                    const countDiv = document.createElement('div');
                    countDiv.className = 'char-count';
                    countDiv.id = `count-${index}-${line}`;
                    countDiv.textContent = `0 / ${req.minCount}-${req.maxCount} characters`;
                    section.appendChild(countDiv);

                    // Feature 1: Violations container
                    const violationsDiv = document.createElement('div');
                    violationsDiv.className = 'violations-container';
                    violationsDiv.id = `violations-${index}-${line}`;
                    section.appendChild(violationsDiv);
                }

                assignmentsDiv.appendChild(section);
            });
        }

        function updateCharacterCount(event) {
            const input = event.target;
            const index = input.getAttribute('data-headline-index');
            const line = input.getAttribute('data-line');
            const req = headlineRequirements[index];
            const value = input.value;
            const count = value.length;

            const countDiv = document.getElementById(`count-${index}-${line}`);
            countDiv.textContent = `${count} / ${req.minCount}-${req.maxCount} characters`;

            if (count < req.minCount || count > req.maxCount) {
                countDiv.classList.add('warning');
            } else {
                countDiv.classList.remove('warning');
            }

            const grid = document.getElementById(`grid-${index}-${line}`);
            const boxes = grid.querySelectorAll('.char-box');
            boxes.forEach((box, i) => {
                box.classList.remove('filled', 'over-limit');
                if (i < count) {
                    if (i < req.maxCount) {
                        box.classList.add('filled');
                        box.textContent = value[i];
                    } else {
                        box.classList.add('over-limit');
                        box.textContent = value[i];
                    }
                } else {
                    box.textContent = String(i + 1);
                }
            });

            // Feature 1: Check and render violations
            const violations = checkViolations(value);
            renderViolations(violations, `violations-${index}-${line}`);
        }

        async function submitHeadlines(skipValidation) {
            // Feature 2: Stop timer on submit
            stopTimer();

            headlines = [];
            let allValid = true;

            headlineRequirements.forEach((req, index) => {
                const headlineLines = [];
                for (let line = 0; line < req.lines; line++) {
                    const input = document.getElementById(`headline-${index}-${line}`);
                    const value = input.value.trim();

                    if (!value) {
                        allValid = false;
                    }

                    headlineLines.push({
                        text: value,
                        charCount: value.length,
                        minRequired: req.minCount,
                        maxRequired: req.maxCount
                    });
                }

                headlines.push({
                    headlineNumber: index + 1,
                    lines: headlineLines,
                    totalLines: req.lines
                });
            });

            if (!allValid && !skipValidation) {
                alert('Please fill in all headline fields before submitting.');
                return;
            }

            document.getElementById('submit-btn').disabled = true;
            document.getElementById('story-section').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                await evaluateHeadlines();
            } catch (error) {
                alert('Error evaluating headlines. Please try again.');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('story-section').style.display = 'block';
                document.getElementById('submit-btn').disabled = false;
            }
        }

        async function evaluateHeadlines() {
            try {
                const response = await fetch('/api/evaluate-headlines', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        story: currentStory,
                        headlines: headlines
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displayFeedback(data);
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        function displayFeedback(evaluation) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';

            const feedbackDiv = document.getElementById('feedback-content');
            feedbackDiv.innerHTML = '';

            // Overall score
            const overallCard = document.createElement('div');
            overallCard.className = 'feedback-card';

            const scoreClass = evaluation.overallScore >= 20 ? 'excellent' :
                              evaluation.overallScore >= 15 ? 'good' :
                              evaluation.overallScore >= 10 ? 'fair' : 'needs-work';

            overallCard.innerHTML = `
                <div class="feedback-headline">Overall Performance</div>
                <div class="score ${scoreClass}">Score: ${evaluation.overallScore}/24</div>
                <div class="feedback-text">${evaluation.overallFeedback}</div>
            `;
            feedbackDiv.appendChild(overallCard);

            // Individual headline feedback
            evaluation.headlines.forEach((hl, index) => {
                const card = document.createElement('div');
                card.className = 'feedback-card';

                const studentHeadline = headlines[index].lines.map(l => l.text).join('<br>');

                const scoreClass = hl.score === 4 ? 'excellent' :
                                  hl.score === 3 ? 'good' :
                                  hl.score === 2 || hl.score === 1 ? 'fair' : 'needs-work';

                let html = `
                    <div class="feedback-headline">Headline ${hl.number}</div>
                    <div class="your-headline">${studentHeadline}</div>
                    <div class="score ${scoreClass}">Score: ${hl.score}/4</div>
                `;

                if (hl.strengths && hl.strengths.length > 0) {
                    html += `
                        <div class="strength">
                            <strong>Strengths:</strong>
                            <ul class="feedback-list">
                                ${hl.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (hl.improvements && hl.improvements.length > 0) {
                    html += `
                        <div class="improvement">
                            <strong>Areas for Improvement:</strong>
                            <ul class="feedback-list">
                                ${hl.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (hl.suggestedRevision) {
                    html += `
                        <div class="feedback-text">
                            <strong>Suggested revision:</strong><br>
                            <div class="your-headline" style="margin-top: 10px;">${hl.suggestedRevision}</div>
                        </div>
                    `;
                }

                html += `<div class="feedback-text" style="margin-top: 15px;">${hl.feedback}</div>`;

                card.innerHTML = html;
                feedbackDiv.appendChild(card);
            });
        }

        function resetApp() {
            // Feature 2: Reset timer
            stopTimer();
            timeRemaining = 1800;
            document.getElementById('timer-bar').className = 'timer-bar';
            document.getElementById('time-up-overlay').classList.remove('visible');
            document.getElementById('mode-selector').style.display = 'flex';

            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('start-section').style.display = 'block';
            document.getElementById('submit-btn').disabled = false;
            currentStory = null;
            headlines = [];

            const startBtn = document.querySelector('#start-section button');
            startBtn.disabled = false;
            startBtn.textContent = 'Generate New Story';
        }
    </script>
</body>
</html>
