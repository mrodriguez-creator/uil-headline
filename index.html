<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIL Headline Writing Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .story-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .story-title {
            font-size: 1.3em;
            color: #1e3c72;
            font-weight: bold;
        }

        .story-text {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }

        .headline-input-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .headline-label {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
            display: block;
        }

        .character-grid {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .char-box {
            width: 24px;
            height: 32px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-family: monospace;
            font-size: 14px;
        }

        .char-box.filled {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .char-box.over-limit {
            background: #ffebee;
            border-color: #f44336;
        }

        .headline-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: Georgia, serif;
            margin-bottom: 8px;
        }

        .headline-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #f44336;
            font-weight: bold;
        }

        .submit-section {
            text-align: center;
            margin: 30px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feedback-section {
            display: none;
            margin-top: 30px;
        }

        .feedback-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feedback-headline {
            font-size: 1.2em;
            color: #1e3c72;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .your-headline {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: Georgia, serif;
            font-size: 1.1em;
        }

        .score {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .score.excellent {
            background: #4caf50;
            color: white;
        }

        .score.good {
            background: #2196f3;
            color: white;
        }

        .score.fair {
            background: #ff9800;
            color: white;
        }

        .score.needs-work {
            background: #f44336;
            color: white;
        }

        .feedback-text {
            line-height: 1.6;
            color: #444;
            margin: 10px 0;
        }

        .feedback-list {
            margin: 15px 0;
            padding-left: 20px;
        }

        .feedback-list li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .improvement {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .strength {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .try-again-btn {
            margin-top: 30px;
            text-align: center;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box strong {
            color: #1976d2;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.6em;
            }
            
            .content {
                padding: 20px;
            }

            .char-box {
                width: 20px;
                height: 28px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ UIL Headline Writing Trainer</h1>
            <p>Practice writing headlines with AI-powered feedback</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>How it works:</strong> You'll receive a randomly generated news story. Write headlines following UIL rules, then get detailed AI feedback to improve your skills!
            </div>

            <div id="start-section">
                <div style="text-align: center; padding: 40px 0;">
                    <button class="btn" onclick="generateStory()">Generate New Story</button>
                </div>
            </div>

            <div id="story-section" style="display: none;">
                <div class="story-section">
                    <div class="story-header">
                        <div class="story-title" id="story-title">Story</div>
                    </div>
                    <div class="story-text" id="story-text"></div>
                </div>

                <div id="headline-assignments"></div>

                <div class="submit-section">
                    <button class="btn" onclick="submitHeadlines()" id="submit-btn">Submit for Feedback</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your headlines...</p>
            </div>

            <div class="feedback-section" id="feedback-section">
                <div id="feedback-content"></div>
                <div class="try-again-btn">
                    <button class="btn" onclick="resetApp()">Try Another Story</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStory = null;
        let headlines = [];

        const headlineRequirements = [
            { lines: 1, minCount: 24, maxCount: 30 },
            { lines: 2, minCount: 24, maxCount: 30 },
            { lines: 3, minCount: 20, maxCount: 26 },
            { lines: 1, minCount: 10, maxCount: 16 },
            { lines: 2, minCount: 20, maxCount: 26 },
            { lines: 1, minCount: 24, maxCount: 30 }
        ];

        async function generateStory() {
            const startBtn = event.target;
            startBtn.disabled = true;
            startBtn.textContent = 'Generating story...';

            try {
                const response = await fetch('/api/generateStory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Generate a realistic high school news story for UIL Headline Writing practice. The story should be 150-250 words, include 2-3 direct quotes from students/teachers/administrators, and cover a newsworthy school event, program, or achievement. Make it sound like actual student journalism.

Topics can include: academic achievements, new programs/classes, school events, student activities, awards, community service, sports achievements, arts performances, fundraisers, policy changes, etc.

Format the response as JSON:
{
  "story": "the full story text with quotes"
}

Make it engaging and appropriate for high school students to practice headline writing.`
                        }]
                    })
                });

                const data = await response.json();
                const content = data.content.find(item => item.type === 'text')?.text || '';
                
                // Extract JSON from response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const storyData = JSON.parse(jsonMatch[0]);
                    currentStory = storyData.story;
                    displayStory();
                } else {
                    throw new Error('Failed to parse story');
                }
            } catch (error) {
                alert('Error generating story. Please try again.');
                startBtn.disabled = false;
                startBtn.textContent = 'Generate New Story';
            }
        }

        function displayStory() {
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('story-section').style.display = 'block';
            document.getElementById('story-text').textContent = currentStory;

            const assignmentsDiv = document.getElementById('headline-assignments');
            assignmentsDiv.innerHTML = '';

            headlineRequirements.forEach((req, index) => {
                const section = document.createElement('div');
                section.className = 'headline-input-section';
                
                const label = document.createElement('label');
                label.className = 'headline-label';
                label.textContent = `Headline ${index + 1} - ${req.lines}-line headline (${req.minCount}-${req.maxCount} characters per line)`;
                section.appendChild(label);

                for (let line = 0; line < req.lines; line++) {
                    const lineLabel = document.createElement('div');
                    lineLabel.style.fontSize = '13px';
                    lineLabel.style.color = '#666';
                    lineLabel.style.marginTop = line > 0 ? '15px' : '10px';
                    lineLabel.style.marginBottom = '8px';
                    lineLabel.textContent = req.lines > 1 ? (line === 0 ? 'Main headline:' : 'Secondary headline:') : 'Headline:';
                    section.appendChild(lineLabel);

                    const grid = document.createElement('div');
                    grid.className = 'character-grid';
                    grid.id = `grid-${index}-${line}`;
                    for (let i = 0; i < req.maxCount; i++) {
                        const box = document.createElement('div');
                        box.className = 'char-box';
                        box.textContent = String(i + 1);
                        grid.appendChild(box);
                    }
                    section.appendChild(grid);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'headline-input';
                    input.id = `headline-${index}-${line}`;
                    input.placeholder = `Enter your ${req.lines > 1 && line > 0 ? 'secondary' : 'main'} headline...`;
                    input.setAttribute('data-headline-index', index);
                    input.setAttribute('data-line', line);
                    input.addEventListener('input', updateCharacterCount);
                    section.appendChild(input);

                    const countDiv = document.createElement('div');
                    countDiv.className = 'char-count';
                    countDiv.id = `count-${index}-${line}`;
                    countDiv.textContent = `0 / ${req.minCount}-${req.maxCount} characters`;
                    section.appendChild(countDiv);
                }

                assignmentsDiv.appendChild(section);
            });
        }

        function updateCharacterCount(event) {
            const input = event.target;
            const index = input.getAttribute('data-headline-index');
            const line = input.getAttribute('data-line');
            const req = headlineRequirements[index];
            const value = input.value;
            const count = value.length;

            const countDiv = document.getElementById(`count-${index}-${line}`);
            countDiv.textContent = `${count} / ${req.minCount}-${req.maxCount} characters`;
            
            if (count < req.minCount || count > req.maxCount) {
                countDiv.classList.add('warning');
            } else {
                countDiv.classList.remove('warning');
            }

            const grid = document.getElementById(`grid-${index}-${line}`);
            const boxes = grid.querySelectorAll('.char-box');
            boxes.forEach((box, i) => {
                box.classList.remove('filled', 'over-limit');
                if (i < count) {
                    if (i < req.maxCount) {
                        box.classList.add('filled');
                        box.textContent = value[i];
                    } else {
                        box.classList.add('over-limit');
                        box.textContent = value[i];
                    }
                } else {
                    box.textContent = String(i + 1);
                }
            });
        }

        async function submitHeadlines() {
            headlines = [];
            let allValid = true;

            headlineRequirements.forEach((req, index) => {
                const headlineLines = [];
                for (let line = 0; line < req.lines; line++) {
                    const input = document.getElementById(`headline-${index}-${line}`);
                    const value = input.value.trim();
                    
                    if (!value) {
                        allValid = false;
                    }
                    
                    headlineLines.push({
                        text: value,
                        charCount: value.length,
                        minRequired: req.minCount,
                        maxRequired: req.maxCount
                    });
                }
                
                headlines.push({
                    headlineNumber: index + 1,
                    lines: headlineLines,
                    totalLines: req.lines
                });
            });

            if (!allValid) {
                alert('Please fill in all headline fields before submitting.');
                return;
            }

            document.getElementById('submit-btn').disabled = true;
            document.getElementById('story-section').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                await evaluateHeadlines();
            } catch (error) {
                alert('Error evaluating headlines. Please try again.');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('story-section').style.display = 'block';
                document.getElementById('submit-btn').disabled = false;
            }
        }

        async function evaluateHeadlines() {
            const headlinesText = headlines.map((h, i) => {
                const lines = h.lines.map((l, lineIndex) => 
                    `  Line ${lineIndex + 1}: "${l.text}" (${l.charCount} chars, required: ${l.minRequired}-${l.maxRequired})`
                ).join('\n');
                return `Headline ${h.headlineNumber} (${h.totalLines}-line):\n${lines}`;
            }).join('\n\n');

            const response = await fetch('/api/evaluateHeadlines', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 3000,
                    messages: [{
                        role: 'user',
                        content: `You are a UIL Headline Writing judge. Grade these student headlines using the official UIL scoring rubric (0-4 points per headline).

STORY:
${currentStory}

STUDENT HEADLINES:
${headlinesText}

OFFICIAL UIL GRADING RUBRIC (0-4 POINTS):

**ZERO POINTS (Disqualified):**
- Over count or under count (if intentional error to fix count = DQ, other headlines get at least 1 point)
- The ONLY DQ is over/under count

**Give ONLY 1 POINT:**
- Misspellings
- Fact errors
- Passive voice verbs (is given, was studied, etc.)
- ALL verbs not written in present or future tense (OK: speak, will resign; NOT OK: spoke, resigned, -ed/-en ending)
- Past tense verbs get 1 point
- Labels (main headlines with NO verb - short hammers don't need verb but main headlines MUST have a verb)
- Repeated words in same headline
- Using ? & , ! and most abbreviations (months, states NOT correct as abbreviations)
- A, an, the (comma/period replace 'and') unless in book/movie titles
- Opinion (adjectives/adverbs) - red car is OK; sloppy is NOT
- 2-line or 3-line headline that doesn't read as 1 sentence
- First & last names together (use 1 name, NOT both)
- No text words, no slang, no say kids
- Don't confuse labels or titles with headlines (headlines have subject & present tense verb)
- Acronyms not used in story
- Use of Leaguetown, LHS or 'our school' (L-words not allowed in ANY UIL journalism)

**Give 2 POINTS:**
- Headline misses main idea
- First names used (with/out last name) - Exception: 2 people w/same last name
- Bad word splits, especially line 1 to line 2 (infinitive 'to' should not split from its object, nor a preposition from its object on 1 line with noun on next line)
- Per AP, word splits from line 2 to line 3 are acceptable, but from lines 1 to 2 are not
- JUDgiNG NOTE: In ties, bad word splits lose
- "Double quotation marks" - Use 'single marks only'
- Widely-known acronyms (YMCA) acceptable, but rarely. StuCo is not
- Comma separates 1 subj/2 vrbs BUT semicolon MUST separate 2 subjs + 2 vrbs ‚Üí 2 different sentences

**Give 3 POINTS:**
- Summarizes main element of story fairly well with info taken from opening/lead ¬∂
- Headlines should come from TOP/2 leads (first 2 ¬∂s of story, not some insignificant details way down below)
- Subject + active present tense verb + direct object (when applicable)
- Headline is okay or correct, but not outstanding
- Facts, spelling and mechanics correct
- NOT trite or cutesy

**Give 4 POINTS:**
- A solid summary, maybe clever or play on words
- NAILS the lead/first 2 ¬∂s with most important info; uses future element, NOT stale, old news
- Clearly tells the story, with every word needed
- Strong verb - Present Tense & Active Voice
- Mechanics, verb tense, facts, spelling correct

CRITICAL RULES TO ENFORCE:
1. ACTIVE VOICE REQUIRED: "Student wins award" NOT "Award won by student"
2. PRESENT/FUTURE TENSE: "Board approves" NOT "Board approved"
3. NO PASSIVE: "is given, was studied, been" = automatic 1 point
4. SUBJECT + VERB + OBJECT format
5. Multi-line headlines MUST read as ONE complete sentence
6. Don't split verb phrases awkwardly between lines
7. Use commas for 'and' - semicolons separate 2 complete clauses
8. No abbreviations unless in the story
9. Facts must match story exactly
10. Use LAST names only (not first, not both)

NOTES: 
- Block letters acceptable (no penalty)
- Use % sign, not word
- Single-digit numbers as words or digits (be consistent, don't BEGIN headline with digit)

For each headline, provide:
- Score (0-4 using rubric above)
- What works well (if any)
- Specific improvements with rubric justification
- Suggested revision (if score < 4)

Format as JSON:
{
  "headlines": [
    {
      "number": 1,
      "score": 0-4,
      "strengths": ["strength1", "strength2"],
      "improvements": ["improvement1 (cite rubric category)", "improvement2"],
      "suggestedRevision": "better headline" or null,
      "feedback": "detailed explanation citing rubric"
    }
  ],
  "overallScore": 0-24,
  "overallFeedback": "summary of performance"
}`
                    }]
                })
            });

            const data = await response.json();
            const content = data.content.find(item => item.type === 'text')?.text || '';
            
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const evaluation = JSON.parse(jsonMatch[0]);
                displayFeedback(evaluation);
            } else {
                throw new Error('Failed to parse evaluation');
            }
        }

        function displayFeedback(evaluation) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';

            const feedbackDiv = document.getElementById('feedback-content');
            feedbackDiv.innerHTML = '';

            // Overall score
            const overallCard = document.createElement('div');
            overallCard.className = 'feedback-card';
            
            const scoreClass = evaluation.overallScore >= 20 ? 'excellent' :
                              evaluation.overallScore >= 15 ? 'good' :
                              evaluation.overallScore >= 10 ? 'fair' : 'needs-work';
            
            overallCard.innerHTML = `
                <div class="feedback-headline">Overall Performance</div>
                <div class="score ${scoreClass}">Score: ${evaluation.overallScore}/24</div>
                <div class="feedback-text">${evaluation.overallFeedback}</div>
            `;
            feedbackDiv.appendChild(overallCard);

            // Individual headline feedback
            evaluation.headlines.forEach((hl, index) => {
                const card = document.createElement('div');
                card.className = 'feedback-card';

                const studentHeadline = headlines[index].lines.map(l => l.text).join('<br>');
                
                const scoreClass = hl.score === 4 ? 'excellent' :
                                  hl.score === 3 ? 'good' :
                                  hl.score === 2 || hl.score === 1 ? 'fair' : 'needs-work';

                let html = `
                    <div class="feedback-headline">Headline ${hl.number}</div>
                    <div class="your-headline">${studentHeadline}</div>
                    <div class="score ${scoreClass}">Score: ${hl.score}/4</div>
                `;

                if (hl.strengths && hl.strengths.length > 0) {
                    html += `
                        <div class="strength">
                            <strong>‚úì Strengths:</strong>
                            <ul class="feedback-list">
                                ${hl.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (hl.improvements && hl.improvements.length > 0) {
                    html += `
                        <div class="improvement">
                            <strong>‚ö† Areas for Improvement:</strong>
                            <ul class="feedback-list">
                                ${hl.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (hl.suggestedRevision) {
                    html += `
                        <div class="feedback-text">
                            <strong>üí° Suggested revision:</strong><br>
                            <div class="your-headline" style="margin-top: 10px;">${hl.suggestedRevision}</div>
                        </div>
                    `;
                }

                html += `<div class="feedback-text" style="margin-top: 15px;">${hl.feedback}</div>`;

                card.innerHTML = html;
                feedbackDiv.appendChild(card);
            });
        }

        function resetApp() {
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('start-section').style.display = 'block';
            document.getElementById('submit-btn').disabled = false;
            currentStory = null;
            headlines = [];
            
            const startBtn = document.querySelector('#start-section button');
            startBtn.disabled = false;
            startBtn.textContent = 'Generate New Story';
        }
    </script>
</body>
</html>
